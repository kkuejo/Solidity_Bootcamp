# Go Ethereumでプライベートネットワークを構築する

**日付**: 2025年11月30日
**学習内容**: Go Ethereumとは何か、プライベートEthereumネットワークの概念、Genesis JSONファイルの構造、WSL2環境でのプライベートネットワーク構築手順

## 1. Go Ethereum（Geth）とは

### 1.1 Go Ethereumの定義

Go Ethereum（通称Geth）は、Ethereumプロトコルの公式実装の1つで、Go言語で記述されたEthereumクライアントです。Gethを使用することで、以下のことができます：

1. **メインネットへの接続**: 実際のEthereumメインネットワークに参加
2. **テストネットへの接続**: Sepolia、Goerliなどのテストネットワークに参加
3. **プライベートネットワークの構築**: 自分だけのEthereumネットワークを作成

### 1.2 Gethの主な機能

- **フルノード**: Ethereumブロックチェーン全体を同期・検証
- **実行レイヤー**: スマートコントラクトの実行とトランザクション処理（The Merge以降はPoSのコンセンサスレイヤーと連携）
- **スマートコントラクトの実行**: EVMを使用してコントラクトを実行
- **アカウント管理**: Ethereumアカウントの作成・管理
- **RPC/IPC通信**: 外部アプリケーションとの通信インターフェース

**注**: The Merge（2022年9月）以降、Ethereumはマイニング（PoW）からステーキング（PoS）に移行しました。現在のGethは実行レイヤーとして機能し、コンセンサス処理は別のクライアント（Prysm、Lighthouse等）が担当します。

### 1.3 なぜプライベートネットワークを作るのか

プライベートネットワークを構築する理由：

1. **開発・テスト環境**: 実際のETHを使わずにDAppを開発・テスト
2. **完全なコントロール**: ネットワークの設定を自由に変更可能
3. **コスト削減**: ガス代が不要（無料でトランザクションを実行）
4. **プライバシー**: 外部に公開されない閉じたネットワーク
5. **高速実行**: ブロック生成時間を自由に設定可能

**メインネット vs プライベートネット比較**:

| 項目 | メインネット | プライベートネット |
|------|------------|------------------|
| 参加者 | 世界中の誰でも | 許可されたノードのみ |
| ETHの価値 | 実際の価値あり | テスト用（価値なし） |
| ガス代 | 必要 | 不要（設定次第） |
| ブロック時間 | 約12秒（固定） | カスタマイズ可能 |
| セキュリティ | 非常に高い | 設定次第 |

## 2. Genesis JSONファイルの理解

### 2.1 Genesis JSONファイルとは

**Genesis（創世記）ファイル**は、プライベートEthereumネットワークの最初のブロック（ブロック0、Genesisブロック）を定義する設定ファイルです。

**重要な役割**:
- ネットワークの初期パラメータを設定
- チェーンIDを定義（ネットワークを識別）
- 初期アカウントにETHを事前割り当て（プリマイニング）
- コンセンサスアルゴリズムの設定

### 2.2 Genesis JSONファイルの構造

典型的なgenesis.jsonファイルの例：

```json
{
  "config": {
    "chainId": 15,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0,
    "petersburgBlock": 0,
    "istanbulBlock": 0
  },
  "difficulty": "1",
  "gasLimit": "8000000",
  "alloc": {}
}
```

### 2.3 各パラメータの詳細説明

#### 2.3.1 config オブジェクト

**chainId**（チェーンID）:
- ネットワークを一意に識別する番号
- **予約されているID**:
  - `1`: Ethereumメインネット
  - `3`: Ropsten テストネット（廃止済み）
  - `4`: Rinkeby テストネット（廃止済み）
  - `5`: Goerli テストネット（2024年廃止済み）
  - `11155111`: Sepolia テストネット（現在の主要テストネット）
  - `17000`: Holesky テストネット（ステーキング・バリデータテスト用）
- **プライベートネット**: 上記以外の任意の数値（例: 15, 3000, 5000）
- **重要性**: EIP-155リプレイ攻撃防止に使用

**homesteadBlock**:
- Ethereumのリリースバージョン「Homestead」を適用するブロック番号
- **Ethereumのバージョン履歴**:
  1. **Frontier**（2015年7月）: 最初のリリース
  2. **Homestead**（2016年3月）: 安定版リリース
  3. **Byzantium**（2017年10月）: メトロポリスの第1段階
  4. **Constantinople**（2019年2月）: メトロポリスの第2段階
  5. **Istanbul**（2019年12月）: ガス代の最適化
  6. **Berlin**（2021年4月）: ガス代調整とEIP-2718（型付きトランザクション）
  7. **London**（2021年8月）: EIP-1559（ベースフィー導入）、EIP-3554（難易度爆弾延期）
  8. **Arrow Glacier**（2021年12月）: 難易度爆弾の延期
  9. **Gray Glacier**（2022年6月）: 難易度爆弾の延期
  10. **Paris**（2022年9月）: **The Merge（マージ）** - Proof of Work から Proof of Stake への移行
  11. **Shanghai**（2023年4月）: ステーキングされたETHの引き出し機能（EIP-4895）
  12. **Cancun-Deneb (Dencun)**（2024年3月13日）: プロト・ダンクシャーディング（EIP-4844）、Layer 2のガス代削減、Blobトランザクション導入
  13. **Pectra（Prague-Electra）**（2025年5月21日）: アカウント抽象化（EIP-7702）、バリデータ体験の改善（EIP-7251、最大有効残高2048 ETH）、スマートコントラクトウォレットの強化
  14. **Fusaka（Osaka-Fulu）**（2025年後半〜2026年予定）: Verkleツリー導入、ステートレスクライアント、さらなるスケーラビリティ向上
- `0` に設定: ブロック0から最新機能を使用

**EIPブロック（eip150Block, eip155Block, eip158Block等）**:
- **EIP**: Ethereum Improvement Proposal（Ethereum改善提案）
- 各EIPが適用されるブロック番号を指定
- **主要なEIPの例**:
  - **EIP-150**: ガスコスト調整
  - **EIP-155**: リプレイ攻撃防止（chainIdを使用）
  - **EIP-158**: ステートクリア（使われていないアカウントを削除）
- `0` に設定: すべての改善をブロック0から適用

#### 2.3.2 difficulty（難易度）

```json
"difficulty": "1"
```

- マイニングの難易度を設定
- **低い値**: ブロック生成が容易（開発向け）
- **高い値**: ブロック生成に時間がかかる（本番向け）
- プライベートネットでは `"1"` または `"0x1"` を推奨

#### 2.3.3 gasLimit（ガスリミット）

```json
"gasLimit": "8000000"
```

- 1ブロックに含められるガスの最大量
- **メインネット**: 約30,000,000（変動）
- **プライベートネット**: 自由に設定可能（通常8,000,000〜30,000,000）
- 大きな値: より多くのトランザクションを1ブロックに含められる

#### 2.3.4 alloc（事前割り当て）

```json
"alloc": {
  "0x0000000000000000000000000000000000000001": {
    "balance": "1000000000000000000000"
  }
}
```

- 特定のアカウントに初期ETHを割り当て
- **使用例**: 開発用アカウントに最初からETHを持たせる
- **balance**: Wei単位で指定（1 ETH = 10^18 Wei）
- 例: `"1000000000000000000000"` = 1000 ETH

### 2.4 Genesis JSONの重要性

**なぜこのファイルが必要か**:

1. **ネットワークの独立性**: 独自のchainIdで他のネットワークと分離
2. **初期状態の定義**: どのようにブロックチェーンが始まるかを決定
3. **互換性の確保**: 同じgenesis.jsonを使うノード同士のみが接続可能
4. **セキュリティ**: 異なるchainIdのネットワーク間でトランザクションが混ざらない

## 3. プライベートネットワーク構築手順（WSL2環境）

### 3.1 前提条件

- **OS**: WSL2（Windows Subsystem for Linux 2）
- **Linuxディストリビューション**: Ubuntu（推奨）
- **必要なもの**: インターネット接続、管理者権限

### 3.2 ステップ1: Go Ethereumのインストール

#### 3.2.1 PPAリポジトリの追加

```bash
sudo add-apt-repository -y ppa:ethereum/ethereum
```

**PPA（Personal Package Archive）とは**:
- Ubuntuで公式リポジトリにないパッケージを提供する仕組み
- Ethereum公式のPPAから最新のGethをインストール可能

**コマンドの説明**:
- `sudo`: 管理者権限で実行
- `add-apt-repository`: リポジトリを追加
- `-y`: 確認プロンプトを自動的に「Yes」で進める
- `ppa:ethereum/ethereum`: Ethereum公式のPPA

#### 3.2.2 パッケージリストの更新

```bash
sudo apt-get update
```

**目的**: 追加したリポジトリを含む最新のパッケージ情報を取得

#### 3.2.3 Gethのインストール

```bash
sudo apt-get install -y ethereum
```

**インストールされるもの**:
- `geth`: メインのGo Ethereumクライアント
- `bootnode`: ブートストラップノード用ツール
- `evm`: Ethereum Virtual Machine実行ツール
- `abigen`: ABIからGoバインディングを生成するツール

#### 3.2.4 インストールの確認

```bash
geth version
```

**出力例**:
```
Geth
Version: 1.13.x
Git Commit: ...
Architecture: amd64
Go Version: go1.21.x
Operating System: linux
```

**確認ポイント**:
- バージョン番号が表示される
- エラーが出ない

### 3.3 ステップ2: Genesis JSONファイルの作成

作業ディレクトリを作成し、genesis.jsonファイルを配置します。

```bash
# 作業ディレクトリの作成
mkdir -p ~/ethereum-private
cd ~/ethereum-private

# genesis.jsonファイルを作成（エディタで編集）
nano genesis.json
```

**genesis.jsonの内容**:
```json
{
  "config": {
    "chainId": 15,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0,
    "petersburgBlock": 0,
    "istanbulBlock": 0
  },
  "difficulty": "1",
  "gasLimit": "8000000",
  "alloc": {}
}
```

**保存方法（nanoエディタ）**:
1. 内容を貼り付け
2. `Ctrl + O` で保存
3. `Enter` で確認
4. `Ctrl + X` で終了

### 3.4 ステップ3: ブロックチェーンの初期化

#### 3.4.1 データディレクトリの初期化

```bash
geth init --datadir mychaindata genesis.json
```

**コマンドの詳細**:
- `geth init`: 初期化モードでGethを起動
- `--datadir mychaindata`: データを保存するディレクトリを指定
- `genesis.json`: 使用するGenesisファイルを指定

**出力例**:
```
INFO [11-30|10:00:00.000] Successfully wrote genesis state
```

**何が起こるか**:
1. `mychaindata` ディレクトリが作成される
2. Genesisブロック（ブロック0）が作成される
3. ブロックチェーンの初期状態が設定される

**ディレクトリ構造**:
```
~/ethereum-private/
├── genesis.json
└── mychaindata/
    ├── geth/
    │   ├── chaindata/     # ブロックデータ
    │   ├── lightchaindata/
    │   └── nodekey        # ノードの秘密鍵
    └── keystore/          # アカウントの秘密鍵
```

### 3.5 ステップ4: プライベートネットワークの起動

#### 3.5.1 基本的な起動方法（推奨されない）

```bash
geth --datadir mychaindata
```

**問題点**:
- この方法だとメインネットに接続しようとする
- genesis.jsonが無視される
- 外部のノードとの同期が始まる

#### 3.5.2 正しい起動方法

```bash
geth --datadir mychaindata --nodiscover --networkid 15 console
```

**パラメータの詳細説明**:

1. **`--datadir mychaindata`**:
   - 使用するデータディレクトリを指定
   - ここにブロックやアカウント情報が保存される

2. **`--nodiscover`**:
   - ノードディスカバリーを無効化
   - **重要**: これがないと同じchainIdの外部ノードを探して接続してしまう
   - プライベートネットワークを完全に隔離

3. **`--networkid 15`**:
   - ネットワークIDを明示的に指定
   - genesis.jsonのchainIdと一致させる必要がある

4. **`console`**:
   - Geth JavaScriptコンソールを起動
   - 対話的にコマンドを実行可能

**起動時の出力例**:
```
INFO [11-30|10:00:00.000] Starting Geth on local node
INFO [11-30|10:00:00.100] Maximum peer count                       ETH=50 LES=0 total=50
INFO [11-30|10:00:00.200] IPC endpoint opened                      url=/path/to/mychaindata/geth.ipc
INFO [11-30|10:00:00.300] HTTP server started                      endpoint=127.0.0.1:8545
Welcome to the Geth JavaScript console!

instance: Geth/v1.13.x/linux-amd64/go1.21.x
datadir: /path/to/mychaindata
modules: admin:1.0 debug:1.0 eth:1.0 miner:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 web3:1.0

To exit, press ctrl-d or type exit
>
```

**確認ポイント**:
- `IPC endpoint opened`: IPCエンドポイントが開かれた
- `HTTP server started`: HTTPサーバーが起動（デフォルト: localhost:8545）
- `modules`: 使用可能なAPIモジュール
- `>`: コンソールが起動（コマンド入力待ち）

#### 3.5.3 バックグラウンドでの起動（オプション）

コンソールを占有したくない場合：

```bash
# バックグラウンドで起動
nohup geth --datadir mychaindata --nodiscover --networkid 15 &

# 後からコンソールに接続
geth attach mychaindata/geth.ipc
```

**`nohup` コマンド**:
- ターミナルを閉じてもプロセスを継続
- 出力は `nohup.out` に保存

**`geth attach` コマンド**:
- 実行中のGethノードに接続
- IPCソケット経由で接続

### 3.6 ステップ5: 動作確認

Gethコンソール内で以下のコマンドを実行し、正しく動作しているか確認します。

#### 3.6.1 ブロック番号の確認

```javascript
> eth.blockNumber
0
```

**期待される結果**: `0`

**意味**:
- ブロック0（Genesisブロック）のみが存在
- まだ新しいブロックが生成されていない
- マイニングが開始されていない

#### 3.6.2 ネットワークIDの確認

```javascript
> net.version
"15"
```

**期待される結果**: `"15"`（genesis.jsonで指定したchainIdと同じ）

**意味**:
- 正しいネットワークに接続されている
- メインネット（ID: 1）やテストネット（ID: 5等）ではない

#### 3.6.3 同期状態の確認

```javascript
> eth.syncing
false
```

**期待される結果**: `false`

**「同期」とは何か**:

ブロックチェーンの同期（Synchronization）とは、**他のノードが持っているブロックチェーンのデータを自分のノードにダウンロードして、最新の状態に追いつく**プロセスです。

**具体例で理解する**:

1. **メインネットに接続した場合**:
   ```
   あなたのノード: ブロック0のみ（起動直後）
   ↓
   他のノード（世界中）: ブロック21,000,000まで存在
   ↓
   同期開始: ブロック1, 2, 3... と順番にダウンロード
   ↓
   同期完了: あなたのノードもブロック21,000,000まで持つ
   ```

2. **「外部のブロック」の意味**:
   - **外部のブロック** = 他のノードが既に作成・検証したブロック
   - 例: メインネットでは、2015年から現在までに生成された2100万個以上のブロック
   - これらのブロックには過去のすべてのトランザクション履歴が含まれる

3. **プライベートネットワークの場合**:
   ```
   あなたのノード: ブロック0のみ（Genesisブロック）
   ↓
   他のノードは存在しない（--nodiscoverで隔離）
   ↓
   同期する相手がいない → eth.syncing = false
   ↓
   これが正常な状態！
   ```

**`eth.syncing`の戻り値の意味**:

- **`false`の場合**:
  - 同期が不要、または同期完了
  - プライベートネットでは常にこの状態

- **同期情報が表示される場合**:
  ```javascript
  > eth.syncing
  {
    currentBlock: 5000,      // 現在ダウンロード済みのブロック
    highestBlock: 21000000,  // 目標のブロック（最新ブロック）
    knownStates: 150000000,  // ダウンロードが必要な状態データ
    pulledStates: 5000000,   // ダウンロード済みの状態データ
    startingBlock: 0         // 同期開始時のブロック
  }
  ```
  - これは外部ネットワークと接続して同期中の証拠

**もし `true` や同期情報が表示される場合**:
- 外部のネットワーク（メインネットや他のプライベートネット）と接続している
- `--nodiscover` パラメータが付いているか確認
- プライベートネットワークが「汚染」されている可能性

#### 3.6.4 接続されているピアの確認

```javascript
> net.peerCount
0
```

**期待される結果**: `0`

**「ピア（Peer）」とは何か**:

**ピア** = **自分以外のEthereumノード**のことです。より正確には、**自分のノードと直接接続している他のノード**を指します。

**具体的な説明**:

1. **ブロックチェーンネットワークの構造**:
   ```
   [あなたのノード] ←→ [ピア1: 東京のノード]
         ↓
   [ピア2: ロンドンのノード]
         ↓
   [ピア3: ニューヨークのノード]
   ```
   - この場合、`net.peerCount = 3`
   - ピア1、ピア2、ピア3が「接続されているピア」

2. **ピアの役割**:
   - **ブロックの共有**: 新しいブロックを受け取る・送信する
   - **トランザクションの伝播**: トランザクションをネットワーク全体に広める
   - **データの検証**: お互いのデータが正しいか確認
   - **同期のサポート**: 古いブロックをダウンロード

3. **メインネットの場合（通常の状態）**:
   ```javascript
   > net.peerCount
   25  // 通常、数十〜百以上のピアに接続

   > admin.peers
   [
     {
       id: "abc123...",
       name: "Geth/v1.13.0/linux",
       network: {
         localAddress: "192.168.1.100:30303",
         remoteAddress: "203.0.113.45:30303"  // 世界中のどこかのノード
       }
     },
     // ... 他のピア情報
   ]
   ```

4. **プライベートネットワークの場合**:
   ```javascript
   > net.peerCount
   0  // ピアなし = 完全に孤立
   ```
   - `--nodiscover`により他のノードを探さない
   - 他のノードからも発見されない
   - **これが正常な状態**（プライベートネットでは意図的に孤立させる）

**なぜプライベートネットではピアが0なのか**:

```
通常のEthereumネットワーク:
┌─────────────────────────────────────┐
│  世界中のノードが相互接続          │
│  [ノードA] ←→ [ノードB] ←→ [ノードC]│
│      ↓            ↓            ↓    │
│  [ノードD] ←→ [ノードE] ←→ [ノードF]│
└─────────────────────────────────────┘

あなたのプライベートネット（--nodiscover使用）:
┌───────────────┐
│ [あなたのノード]│  ← 完全に隔離、誰とも接続しない
└───────────────┘
```

**もしピア数が0以外だった場合**:
```javascript
> net.peerCount
3  // プライベートネットで0以外は異常！
```

**原因の可能性**:
1. `--nodiscover`を付け忘れた
2. 同じchainIdを使っている外部ノードが存在し、接続された
3. 手動で他のノードを追加した（`admin.addPeer()`）

**ピアの詳細情報を確認**:
```javascript
> admin.peers
[]  // プライベートネットでは空の配列が正常
```

#### 3.6.5 アカウント一覧の確認

```javascript
> eth.accounts
[]
```

**期待される結果**: `[]`（空の配列）

**「アカウント」とは何か**:

Ethereumの**アカウント**とは、ETHを保有したり、トランザクションを送信したりするための**ウォレット（財布）**のようなものです。

**アカウントの基本構造**:

1. **アドレス**（公開情報）:
   ```
   0x1234567890abcdef1234567890abcdef12345678
   ```
   - 42文字（`0x` + 40文字の16進数）
   - 銀行口座番号のようなもの
   - 誰にでも公開できる

2. **秘密鍵**（機密情報）:
   ```
   0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
   ```
   - 64文字の16進数
   - パスワードのようなもの
   - **絶対に他人に見せてはいけない**

**`eth.accounts`の意味**:

このコマンドは、**このGethノードが管理しているアカウントの一覧**を表示します。

**具体例で理解する**:

1. **初期状態（アカウント未作成）**:
   ```javascript
   > eth.accounts
   []  // 空の配列 = アカウントが1つもない
   ```

2. **アカウントを1つ作成した後**:
   ```javascript
   > personal.newAccount("mypassword")
   "0xabcd1234567890abcdef1234567890abcd123456"

   > eth.accounts
   ["0xabcd1234567890abcdef1234567890abcd123456"]
   // 1つのアカウントが存在
   ```

3. **アカウントを複数作成した場合**:
   ```javascript
   > personal.newAccount("password1")
   "0xaaaa1111111111111111111111111111aaaa1111"

   > personal.newAccount("password2")
   "0xbbbb2222222222222222222222222222bbbb2222"

   > eth.accounts
   [
     "0xaaaa1111111111111111111111111111aaaa1111",
     "0xbbbb2222222222222222222222222222bbbb2222"
   ]
   // 2つのアカウントが存在
   ```

**アカウントの用途**:

```javascript
// アカウント0番（最初のアカウント）の残高を確認
> eth.getBalance(eth.accounts[0])
0  // 最初は0 Wei

// アカウント間でETHを送金（事前にETHを持っている場合）
> eth.sendTransaction({
    from: eth.accounts[0],
    to: eth.accounts[1],
    value: web3.toWei(10, "ether")
  })
```

**ETHの取得方法**:
- プライベートネットワークでは、genesis.jsonの`alloc`で事前にETHを割り当て可能
- または開発目的でPoWマイニングも可能（`miner.start()`）
- 次回学習予定のPoS実装では、バリデータとしてステーキングを行う

**なぜ初期状態では空なのか**:

- Gethは起動時に**自動的にアカウントを作成しない**
- セキュリティのため、ユーザーが明示的に作成する必要がある
- MetaMaskのようなウォレットも同様（最初は空、ユーザーが作成またはインポート）

**アカウントの保存場所**:

```bash
~/ethereum-private/mychaindata/keystore/
```

このディレクトリに、暗号化された秘密鍵ファイルが保存されます：

```bash
$ ls mychaindata/keystore/
UTC--2025-11-30T12-00-00.123456789Z--abcd1234567890abcdef1234567890abcd123456
```

**重要な注意点**:

1. **パスワードを忘れない**: アカウントのパスワードを忘れると、そのアカウントは永久に使えなくなる
2. **keystoreフォルダをバックアップ**: このフォルダを失うと、すべてのアカウント（とETH）を失う
3. **秘密鍵を共有しない**: 秘密鍵を知っている人は、そのアカウントを完全にコントロールできる

#### 3.6.6 コンソールの終了

```javascript
> exit
```

または `Ctrl + D` を押す。

## 4. Gethの2つのモード

### 4.1 通常モード（Geth実行モード）

```bash
geth [オプション]
```

**用途**: Ethereumノードとして実行

**主な動作**:
- ブロックチェーンの同期
- トランザクションの処理
- 実行レイヤーとしての動作（The Merge以降）
- RPCサーバーの提供

**注**: メインネットでは、The Merge以降マイニングは廃止されました。プライベートネットワークでは、開発・学習目的でPoWマイニングも可能ですが、本番環境と同じPoS（Proof of Stake）を学ぶには、Prysmなどのコンセンサスクライアントとの連携が必要です。

### 4.2 初期化モード

```bash
geth init [genesis.json] --datadir [directory]
```

**用途**: 新しいブロックチェーンの初期化

**主な動作**:
- Genesisブロックの作成
- データディレクトリの準備
- 初期設定の適用

**重要**: 初期化は1度だけ実行（再実行するとエラー）

## 5. ディスカバリーモードの重要性

### 5.1 ディスカバリーモードとは

**ノードディスカバリー**:
- Ethereumノードが他のノードを自動的に発見する仕組み
- UDPプロトコルを使用
- 同じネットワークID（chainId）を持つノードを探す

### 5.2 なぜ `--nodiscover` が必要か

**問題のシナリオ**:
1. `--nodiscover` なしでプライベートネットを起動
2. インターネット上で同じchainId（例: 15）を使っている他のノードを発見
3. 自動的にその外部ノードに接続
4. 外部ノードからブロックをダウンロード開始
5. 自分のプライベートネットワークが汚染される

**`--nodiscover` の効果**:
- UDPリスナーを起動しない
- 他のノードを探さない
- 他のノードから発見されない
- 完全に隔離されたプライベートネットワーク

**確認方法**:
```javascript
> admin.nodeInfo.protocols.eth.network
15

> net.listening
true  // IPCとHTTPはリスニング

> admin.nodeInfo.protocols.discovery
undefined  // ディスカバリーは無効
```

## 6. プライベートネットワークの活用

### 6.1 基本的な使い方

プライベートネットワークが起動したら、以下のことができます：

#### 6.1.1 アカウントの作成

```javascript
> personal.newAccount("password")
"0x1234567890abcdef1234567890abcdef12345678"
```

#### 6.1.2 ブロック生成とETHの取得

**注**: プライベートネットワークでは、開発目的でPoWマイニングが可能ですが、本日の学習では基本的な動作確認のみを行いました。

**PoWマイニング（プライベートネットのみ）**:
```javascript
> miner.start(1)  // 1スレッドでマイニング開始（プライベートネットのみ）
null

> eth.blockNumber
// ブロックが増えていく: 1, 2, 3, ...

> miner.stop()
null

> eth.getBalance(eth.accounts[0])
// マイニング報酬でETHが増加
```

**重要**: The Merge以降、Ethereumメインネットではマイニングは廃止されました。本番環境と同じPoS（Proof of Stake）を実装するには、**Prysm**などのコンセンサスクライアントと連携する必要があります。次回の学習では、GethとPrysmを使用したPoSの実装を予定しています。

### 6.2 スマートコントラクトのデプロイ

プライベートネットワークは、スマートコントラクトの開発・テストに最適です：

1. **Remix IDE**等で作成したコントラクトをデプロイ
2. ガス代を気にせずテスト
3. 何度でもやり直し可能
4. デバッグが容易

### 6.3 DAppとの連携

**Web3.jsやEthers.js**を使用してフロントエンドから接続：

```javascript
// Web3.js の例
const Web3 = require('web3');
const web3 = new Web3('http://localhost:8545');

// アカウント一覧を取得
web3.eth.getAccounts().then(console.log);
```

## 7. トラブルシューティング

### 7.1 Gethが起動しない

**症状**: コマンド実行時にエラーが出る

**原因と解決策**:

1. **Gethがインストールされていない**:
   ```bash
   geth version
   # command not found → 再インストール
   ```

2. **genesis.jsonの構文エラー**:
   - JSONの記法を確認（カンマ、括弧の閉じ忘れ等）
   - オンラインJSONバリデーターで検証

3. **ポートが既に使用されている**:
   ```bash
   # ポート8545を使用中のプロセスを確認
   lsof -i :8545

   # 別のポートを指定
   geth --datadir mychaindata --nodiscover --networkid 15 --port 30304 --http.port 8546 console
   ```

### 7.2 ブロックが同期し始める

**症状**: `eth.syncing` が `false` にならない

**原因**: `--nodiscover` を付け忘れ、外部ノードと接続

**解決策**:
1. Gethを停止（`exit` または `Ctrl + C`）
2. データディレクトリを削除
   ```bash
   rm -rf mychaindata
   ```
3. 再初期化
   ```bash
   geth init --datadir mychaindata genesis.json
   ```
4. `--nodiscover` を付けて起動

### 7.3 アカウントが作成できない

**症状**: `personal.newAccount()` がエラー

**原因**: `personal` APIが有効になっていない

**解決策**:
```bash
geth --datadir mychaindata --nodiscover --networkid 15 --http --http.api "eth,net,web3,personal" console
```

### 7.4 MetaMaskから接続できない

**症状**: MetaMaskでネットワークに接続できない

**解決策**:
1. HTTP RPCを有効化して起動
   ```bash
   geth --datadir mychaindata --nodiscover --networkid 15 --http --http.addr "0.0.0.0" --http.corsdomain "*" console
   ```

2. MetaMaskでネットワークを追加:
   - **RPC URL**: `http://localhost:8545`
   - **Chain ID**: `15`
   - **通貨記号**: ETH

## 8. Anvilとの比較

### 8.1 Geth vs Anvil

今回学習したGethと、以前使用したAnvil（Foundryツール）の違い：

| 項目 | Geth | Anvil |
|------|------|-------|
| 主な用途 | 本格的なノード運用 | 開発・テスト |
| 起動速度 | 遅い | 非常に速い |
| ブロック生成 | 設定が必要（PoWまたはPoS） | 自動（即座に生成） |
| アカウント | 自分で作成 | 10個自動生成 |
| 設定 | genesis.json | コマンドライン引数 |
| データ永続化 | デフォルトで永続化 | デフォルトで揮発性 |
| 実環境への近さ | 本番環境に近い（PoS対応） | 簡略化されている |

### 8.2 使い分けの推奨

**Anvil を使うべき場合**:
- 迅速なスマートコントラクト開発
- Foundryのテストフレームワークを使用
- 頻繁にリセットが必要

**Geth を使うべき場合**:
- 本番環境に近い動作検証
- ノードの設定・運用を学習
- 永続的なブロックチェーンが必要
- PoS（Proof of Stake）の仕組みを理解（Prysmと連携）

## 9. 学習のまとめ

### 9.1 習得した知識

1. **Go Ethereumの基礎**:
   - Gethとは何か、何ができるか
   - メインネット、テストネット、プライベートネットの違い

2. **Genesis JSONファイル**:
   - 各パラメータの意味（chainId, difficulty, gasLimit等）
   - ネットワークの初期設定の重要性
   - EIPの概念とEthereumのバージョン履歴

3. **プライベートネットワークの構築**:
   - WSL2環境でのGethインストール
   - genesis.jsonファイルの作成
   - データディレクトリの初期化
   - 正しい起動パラメータ（`--nodiscover`, `--networkid`）

4. **ノードの動作確認**:
   - Gethコンソールの基本コマンド
   - ブロックチェーンの状態確認
   - ディスカバリーモードの理解

### 9.2 実践した手順

実際にWSL2環境で以下を実行しました：

```bash
# 1. Gethのインストール
sudo add-apt-repository -y ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install -y ethereum
geth version

# 2. Genesis JSONファイルの作成
mkdir -p ~/ethereum-private
cd ~/ethereum-private
nano genesis.json  # ファイルを編集

# 3. ブロックチェーンの初期化
geth init --datadir mychaindata genesis.json

# 4. プライベートネットワークの起動
geth --datadir mychaindata --nodiscover --networkid 15 console

# 5. 動作確認（Gethコンソール内）
> eth.blockNumber      # 0
> net.version          # "15"
> eth.syncing          # false
> exit
```

### 9.3 重要なポイント

1. **chainIdの選択**:
   - 1, 2, 3は使用不可（メインネット・テストネット用）
   - プライベートネットでは任意の値（15, 3000等）

2. **`--nodiscover` の必須性**:
   - これがないと外部ノードと接続する可能性
   - プライベートネットワークの隔離を保証

3. **初期化と起動の分離**:
   - `geth init`: 1度だけ実行（Genesisブロック作成）
   - `geth [options]`: 通常の起動（繰り返し可能）

4. **データディレクトリの重要性**:
   - すべてのブロックチェーンデータが保存される
   - 削除すると初期化からやり直し

## 10. 次のステップ

### 10.1 推奨される学習内容

今後は以下の内容に進むことをお勧めします：

1. **Proof of Stake（PoS）の実装**:
   - Prysmコンセンサスクライアントのインストール
   - GethとPrysmの連携設定
   - バリデータの設定とステーキング
   - 本番環境と同じPoSメカニズムの理解

2. **アカウント管理**:
   - アカウントの作成（`personal.newAccount()`）
   - アカウントのロック/アンロック
   - 秘密鍵のエクスポート/インポート

3. **トランザクション**:
   - ETHの送金
   - ガス代の概念
   - トランザクションの確認

4. **スマートコントラクト**:
   - プライベートネットへのデプロイ
   - Remixとの連携
   - Web3.jsやEthers.jsでの操作

5. **複数ノードの接続**:
   - 2つ目のノードの起動
   - ノード間の接続（`admin.addPeer()`）
   - プライベートネットワークの拡張

### 10.2 参考リソース

- **Geth公式ドキュメント**: https://geth.ethereum.org/docs/
- **Prysm公式ドキュメント**: https://docs.prylabs.network/
- **Ethereum.org - PoS**: https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/
- **Ethereum Improvement Proposals**: https://eips.ethereum.org/
- **Foundry Book**: https://book.getfoundry.sh/

### 10.3 最後に

本日の学習を通じて、Ethereumブロックチェーンの基盤技術であるGethの基本を理解し、実際にプライベートネットワークを構築することができました。

**今後の学習の流れ**:
1. **本日**: Gethのインストールとプライベートネットワークの基本構築
2. **次回**: PrysmとGethを連携させたPoS（Proof of Stake）の実装
3. **今後**: スマートコントラクトのデプロイとDApp開発

**AnvilとGethの両方を理解する価値**:
- **Anvil**: 高速な開発サイクル、Foundryとの統合、迅速なテスト
- **Geth + Prysm**: 本番環境への理解、PoSの仕組み、ノード運用の学習

**The Mergeの重要性**:
The Merge（2022年9月）により、Ethereumはエネルギー効率的なPoSに移行しました。次回の学習では、このPoSメカニズムを実際に体験し、バリデータとしてネットワークに参加する方法を学びます。

この知識は、DApp開発だけでなく、Ethereumエコシステム全体の理解に役立ちます。引き続き、実際にアカウントを作成し、PoSを実装し、スマートコントラクトをデプロイしてみましょう！
