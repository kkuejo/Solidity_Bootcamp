# プライベートPoSネットワークの構築と問題解決

**日付**: 2025年12月3日〜4日
**学習内容**: GethとPrysmを使用したプライベートProof of Stakeネットワークの構築、Genesis Time問題の根本原因の特定と解決、正しいセットアップ手順の確立

## 1. 学習の背景と目的

### 1.1 前回の学習内容

2025年11月30日の学習では、以下を実施しました：

1. **Go Ethereum（Geth）のインストール**
2. **Genesis JSONファイルの作成**
3. **プライベートネットワークの基本構築**
4. **Gethコンソールでの動作確認**

しかし、The Merge（2022年9月）以降、Ethereumは**PoW（Proof of Work）**から**PoS（Proof of Stake）**に移行しており、実際にブロックを生成するには**コンセンサスクライアント**が必要です。

### 1.2 本学習の目的

本学習では、以下を達成します：

1. **Prysmコンセンサスクライアントの導入**
2. **GethとPrysmの連携設定**
3. **プライベートPoSネットワークの完全な構築**
4. **発生した問題の根本原因の特定と解決**
5. **継続的なブロック生成の実現**

### 1.3 Ethereum PoSアーキテクチャの理解

**The Merge以降のEthereumアーキテクチャ**:

```
┌─────────────────────────────────────────────┐
│        Ethereum PoS Network                │
├─────────────────────────────────────────────┤
│                                             │
│  ┌───────────────────────────────────┐     │
│  │   Consensus Layer (Prysm)        │     │
│  │   - ブロックの提案と検証          │     │
│  │   - バリデータの管理              │     │
│  │   - ステーキング報酬の分配         │     │
│  └───────────────┬───────────────────┘     │
│                  │ Engine API (JWT認証)    │
│  ┌───────────────┴───────────────────┐     │
│  │   Execution Layer (Geth)         │     │
│  │   - スマートコントラクトの実行     │     │
│  │   - トランザクション処理           │     │
│  │   - 状態管理                      │     │
│  └───────────────────────────────────┘     │
│                                             │
└─────────────────────────────────────────────┘
```

**各レイヤーの役割**:

| レイヤー | クライアント | 主な役割 |
|----------|------------|---------|
| **コンセンサスレイヤー** | Prysm, Lighthouse, Teku等 | ブロックの提案・検証、バリデータ管理 |
| **実行レイヤー** | Geth, Nethermind, Besu等 | トランザクション実行、状態管理 |

## 2. 必要なコンポーネント

### 2.1 実行レイヤー（Execution Layer）

**Geth（Go Ethereum）**:
- 既に前回の学習でインストール済み
- トランザクションの実行環境を提供
- EVM（Ethereum Virtual Machine）を実装

### 2.2 コンセンサスレイヤー（Consensus Layer）

**Prysm**:
- Go言語で実装されたEthereum 2.0クライアント
- ビーコンチェーン（Beacon Chain）とバリデータを提供
- 最も広く使用されているコンセンサスクライアントの1つ

**Prysmの主要コンポーネント**:

1. **Beacon Chain（ビーコンチェーン）**:
   - PoSプロトコルの中心
   - バリデータの状態を管理
   - ブロックの提案スケジュールを決定

2. **Validator（バリデータ）**:
   - 32 ETHをステーキング
   - ブロックを提案・証明
   - 報酬を獲得

### 2.3 両者の連携

**Engine API**:
- Geth ↔ Prysm間の通信インターフェース
- **JWT（JSON Web Token）認証**で保護
- HTTP/WebSocket経由で通信

```
Prysm (Consensus)
     ↓ Engine API (JWT認証)
     ↓ http://localhost:8551
Geth (Execution)
```

## 3. 環境セットアップ

### 3.1 ディレクトリ構造

```bash
~/eth-private-pos/
├── execution/               # Geth用ディレクトリ
│   ├── genesis.json         # 実行レイヤーのGenesis設定
│   ├── genesis-updated.json # Prysmが生成した更新版
│   └── data/                # Gethのデータディレクトリ
├── consensus/               # Prysm用ディレクトリ
│   ├── config.yaml          # コンセンサスレイヤーの設定
│   ├── genesis.ssz          # Beacon ChainのGenesis状態
│   ├── beacon-data/         # Beacon Chainのデータ
│   └── validator-data/      # Validatorのデータ
├── jwt.hex                  # JWT秘密鍵（認証用）
├── prysm.sh                 # Prysm起動スクリプト
├── prysmctl                 # Genesis生成ツール
└── dist/                    # Prysmバイナリ
    ├── beacon-chain-v7.0.0-linux-amd64
    └── validator-v7.0.0-linux-amd64
```

### 3.2 Prysmのインストール

#### 3.2.1 prysm.shスクリプトのダウンロード

```bash
# 作業ディレクトリに移動
cd ~/eth-private-pos

# prysm.shをダウンロード
curl https://raw.githubusercontent.com/prysmaticlabs/prysm/master/prysm.sh --output prysm.sh
chmod +x prysm.sh
```

**prysm.shの役割**:
- 必要なPrysmバイナリを自動ダウンロード
- 適切なバージョンを管理
- 実行を簡略化

#### 3.2.2 prysmctlのダウンロード

```bash
# Genesis生成用のprysmctlをダウンロード
curl -L https://github.com/prysmaticlabs/prysm/releases/download/v7.0.0/prysmctl-v7.0.0-linux-amd64 -o prysmctl
chmod +x prysmctl
```

**prysmctlの役割**:
- ビーコンチェーンのGenesis状態（genesis.ssz）を生成
- Gethのgenesis.jsonを更新
- バリデータキーの生成（オプション）

### 3.3 JWT秘密鍵の生成

GethとPrysm間の通信を保護するJWT秘密鍵を生成します。

```bash
# JWT秘密鍵を生成（32バイトのランダムな16進数）
openssl rand -hex 32 > jwt.hex

# 確認
cat jwt.hex
# 出力例: a1b2c3d4e5f6... (64文字の16進数)
```

**JWT認証の重要性**:
- GethとPrysmは同じjwt.hexファイルを使用
- 不正なクライアントの接続を防止
- Engine APIの安全性を確保

## 4. 設定ファイルの作成

### 4.1 Geth用Genesis JSON

前回作成した`execution/genesis.json`を確認します：

```json
{
  "config": {
    "chainId": 32382,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0,
    "petersburgBlock": 0,
    "istanbulBlock": 0,
    "berlinBlock": 0,
    "londonBlock": 0,
    "mergeNetsplitBlock": 0,
    "terminalTotalDifficulty": 0,
    "terminalTotalDifficultyPassed": true
  },
  "difficulty": "0x1",
  "gasLimit": "0x8000000",
  "baseFeePerGas": "0x7",
  "alloc": {}
}
```

**PoS対応の重要なパラメータ**:

| パラメータ | 値 | 説明 |
|-----------|---|------|
| `mergeNetsplitBlock` | 0 | The Mergeをブロック0で適用 |
| `terminalTotalDifficulty` | 0 | PoWからPoSへの移行閾値（0 = 最初からPoS） |
| `terminalTotalDifficultyPassed` | true | PoSに移行済みであることを示すフラグ |
| `baseFeePerGas` | "0x7" | Post-Mergeネットワークに必須 |

### 4.2 Prysm用config.yaml

**重要な発見**: 本学習で、`config.yaml`の設定ミスが多くの問題の根本原因であることが判明しました。

#### 4.2.1 誤った設定（問題が発生）

```yaml
CONFIG_NAME: mainnet  # ❌ これが問題の原因！
PRESET_BASE: mainnet

GENESIS_FORK_VERSION: 0x00000000  # ❌ これも問題！
ALTAIR_FORK_VERSION: 0x01020304
BELLATRIX_FORK_VERSION: 0x02030405
CAPELLA_FORK_VERSION: 0x03040506
DENEB_FORK_VERSION: 0x04050607
# ... 以下略
```

**この設定の問題点**:

1. **CONFIG_NAME: mainnet**
   - Prysmが内蔵の**mainnetプリセット**を使用
   - mainnetのgenesis time（2020-12-01 13:00:23）を強制的に適用
   - `--genesis-time-delay`オプションが無視される

2. **GENESIS_FORK_VERSION: 0x00000000**
   - mainnetのデフォルト値と同じ
   - CONFIG_NAMEを変更すると競合エラーが発生

#### 4.2.2 正しい設定（問題解決）

```yaml
CONFIG_NAME: private-pos  # ✅ 固有の名前に変更
PRESET_BASE: mainnet

# ✅ 固有のfork versionに変更
GENESIS_FORK_VERSION: 0x10000000
ALTAIR_FORK_VERSION: 0x20000000
BELLATRIX_FORK_VERSION: 0x30000000
CAPELLA_FORK_VERSION: 0x40000000
DENEB_FORK_VERSION: 0x50000000
ELECTRA_FORK_VERSION: 0x60000000
FULU_FORK_VERSION: 0x70000000

ALTAIR_FORK_EPOCH: 0
BELLATRIX_FORK_EPOCH: 0
CAPELLA_FORK_EPOCH: 0
DENEB_FORK_EPOCH: 0
ELECTRA_FORK_EPOCH: 18446744073709551615
FULU_FORK_EPOCH: 18446744073709551615

TERMINAL_TOTAL_DIFFICULTY: 0

MIN_GENESIS_ACTIVE_VALIDATOR_COUNT: 1
MIN_GENESIS_TIME: 0
GENESIS_DELAY: 0

SECONDS_PER_SLOT: 12
SLOTS_PER_EPOCH: 32

ETH1_FOLLOW_DISTANCE: 1
```

**変更のポイント**:

| パラメータ | 変更前 | 変更後 | 理由 |
|-----------|-------|-------|------|
| CONFIG_NAME | mainnet | private-pos | 内蔵プリセットとの競合を回避 |
| GENESIS_FORK_VERSION | 0x00000000 | 0x10000000 | mainnetとの重複を回避 |
| 他のFORK_VERSION | 0x0102... | 0x2000... | 一貫性を保つため |

#### 4.2.3 config.yamlの作成

```bash
cd ~/eth-private-pos
mkdir -p consensus
cat > consensus/config.yaml << 'EOF'
CONFIG_NAME: private-pos
PRESET_BASE: mainnet

GENESIS_FORK_VERSION: 0x10000000
ALTAIR_FORK_VERSION: 0x20000000
BELLATRIX_FORK_VERSION: 0x30000000
CAPELLA_FORK_VERSION: 0x40000000
DENEB_FORK_VERSION: 0x50000000
ELECTRA_FORK_VERSION: 0x60000000
FULU_FORK_VERSION: 0x70000000

ALTAIR_FORK_EPOCH: 0
BELLATRIX_FORK_EPOCH: 0
CAPELLA_FORK_EPOCH: 0
DENEB_FORK_EPOCH: 0
ELECTRA_FORK_EPOCH: 18446744073709551615
FULU_FORK_EPOCH: 18446744073709551615

TERMINAL_TOTAL_DIFFICULTY: 0

MIN_GENESIS_ACTIVE_VALIDATOR_COUNT: 1
MIN_GENESIS_TIME: 0
GENESIS_DELAY: 0

SECONDS_PER_SLOT: 12
SLOTS_PER_EPOCH: 32

ETH1_FOLLOW_DISTANCE: 1
EOF
```

**主要パラメータの説明**:

| パラメータ | 値 | 説明 |
|-----------|---|------|
| `MIN_GENESIS_ACTIVE_VALIDATOR_COUNT` | 1 | 最小バリデータ数（プライベートネットは1でOK） |
| `MIN_GENESIS_TIME` | 0 | Genesis時刻の最小値（0 = 制限なし） |
| `GENESIS_DELAY` | 0 | Genesis後の待機時間（秒） |
| `SECONDS_PER_SLOT` | 12 | スロット間隔（mainnetと同じ） |
| `SLOTS_PER_EPOCH` | 32 | 1エポックあたりのスロット数 |
| `ELECTRA_FORK_EPOCH` | 18446744073709551615 | 遠い将来（実質無効） |

## 5. Genesis状態の生成

### 5.1 genesis.sszとは

**genesis.ssz**:
- Beacon ChainのGenesis（初期）状態を定義するファイル
- SSZ（Simple Serialize）形式でエンコード
- バリデータの初期情報を含む

**Gethのgenesis.jsonとの違い**:

| 項目 | genesis.json (Geth) | genesis.ssz (Prysm) |
|------|-------------------|-------------------|
| レイヤー | 実行レイヤー | コンセンサスレイヤー |
| 形式 | JSON | SSZ（バイナリ） |
| 内容 | chainId, gasLimit等 | バリデータ情報、genesis time等 |

### 5.2 prysmctlによるgenesis.ssz生成

```bash
cd ~/eth-private-pos

./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 1 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz
```

**コマンドの詳細**:

| オプション | 説明 |
|-----------|------|
| `--fork deneb` | Deneb forkを使用（最新のEthereumアップグレード） |
| `--num-validators 1` | バリデータを1つ生成 |
| `--genesis-time-delay 120` | 現在時刻から120秒後をgenesis timeに設定 |
| `--chain-config-file` | 使用するconfig.yamlを指定 |
| `--geth-genesis-json-in` | 入力するGethのgenesis.json |
| `--geth-genesis-json-out` | 出力するGethの更新版genesis.json |
| `--output-ssz` | 出力するgenesis.sszファイル |

**出力例**:
```
time="2025-12-04T07:46:48+01:00" level=info msg="Specified a chain config file: consensus/config.yaml"
time="2025-12-04T07:46:48+01:00" level=info msg="No genesis time specified, defaulting to now()"
time="2025-12-04T07:46:48+01:00" level=info msg="Delaying genesis 1764830808 by 120 seconds"
time="2025-12-04T07:46:48+01:00" level=info msg="Genesis is now 1764830928"
time="2025-12-04T07:46:48+01:00" level=info msg="Setting fork geth times" cancun=1764830928 shanghai=1764830928
time="2025-12-04T07:46:48+01:00" level=info msg="Done writing genesis state to consensus/genesis.ssz"
```

**重要なポイント**:
- Genesis time: 1764830928（2025-12-04 07:48:48）
- 現在時刻から120秒後に設定される
- Gethのfork times（shanghai, cancun）も自動設定

### 5.3 genesis-updated.jsonへのblobSchedule追加

Deneb fork以降、blobScheduleの設定が必要です。

```bash
python3 << 'PYTHON'
import json

with open('execution/genesis-updated.json', 'r') as f:
    genesis = json.load(f)

if 'blobSchedule' not in genesis.get('config', {}):
    genesis['config']['blobSchedule'] = {
        "cancun": {
            "blobGasTarget": 393216,
            "maxBlobGasPerBlock": 786432
        }
    }

    with open('execution/genesis-updated.json', 'w') as f:
        json.dump(genesis, f, indent='\t')
    print("blobScheduleを追加しました")
else:
    print("blobScheduleは既に存在します")
PYTHON
```

**blobScheduleの役割**:
- **Blob transactions**（EIP-4844）に対応
- Layer 2のガス代削減に貢献
- Proto-Danksharding実装の一部

## 6. Gethの初期化と起動

### 6.1 Gethの初期化

```bash
cd ~/eth-private-pos

# 既存データがあれば削除
rm -rf execution/data/geth

# genesis-updated.jsonで初期化
geth init --datadir execution/data execution/genesis-updated.json
```

**出力例**:
```
INFO [12-04|07:42:43.247] Maximum peer count                       ETH=50 total=50
INFO [12-04|07:42:43.257] Set global gas cap                       cap=50,000,000
INFO [12-04|07:42:43.257] Initializing the KZG library             backend=gokzg
INFO [12-04|07:42:43.375] Successfully wrote genesis state         database=chaindata hash=e224f8..19a064
```

### 6.2 Gethの起動

```bash
geth --datadir execution/data \
  --networkid 32382 \
  --http \
  --http.api eth,net,web3,engine,admin \
  --http.addr 0.0.0.0 \
  --http.corsdomain "*" \
  --ws \
  --ws.api eth,net,web3,engine,admin \
  --authrpc.addr 0.0.0.0 \
  --authrpc.port 8551 \
  --authrpc.jwtsecret jwt.hex \
  --authrpc.vhosts "*" \
  --nodiscover \
  --syncmode full
```

**新しいオプションの説明**:

| オプション | 説明 |
|-----------|------|
| `--http` | HTTP RPCサーバーを有効化 |
| `--http.api eth,net,web3,engine,admin` | 公開するAPIモジュール |
| `--ws` | WebSocket RPCサーバーを有効化 |
| `--authrpc.addr 0.0.0.0` | Engine APIのアドレス |
| `--authrpc.port 8551` | Engine APIのポート（デフォルト） |
| `--authrpc.jwtsecret jwt.hex` | JWT認証ファイルを指定 |
| `--authrpc.vhosts "*"` | すべてのvirtual hostを許可 |

**Engine APIのエンドポイント**:
```
http://localhost:8551
```

このエンドポイントにPrysmが接続します。

## 7. Beacon Chainの起動

### 7.1 Beacon Chainとは

**Beacon Chain（ビーコンチェーン）**:
- PoSプロトコルの中核
- バリデータの状態を追跡
- ブロック提案のスケジュールを管理
- Finalityを決定

**主な責務**:
1. バリデータの登録・管理
2. ブロック提案者の選択
3. 証明（attestation）の集約
4. Finalityチェックポイントの決定

### 7.2 Beacon Chainの起動

```bash
cd ~/eth-private-pos

./dist/beacon-chain-v7.0.0-linux-amd64 \
  --datadir consensus/beacon-data \
  --min-sync-peers 0 \
  --genesis-state consensus/genesis.ssz \
  --chain-config-file consensus/config.yaml \
  --config-file consensus/config.yaml \
  --chain-id 32382 \
  --execution-endpoint http://localhost:8551 \
  --accept-terms-of-use \
  --jwt-secret jwt.hex \
  --contract-deployment-block 0 \
  --p2p-static-id \
  --bootstrap-node "" \
  --interop-eth1data-votes
```

**オプションの詳細**:

| オプション | 説明 |
|-----------|------|
| `--datadir` | Beacon Chainのデータディレクトリ |
| `--min-sync-peers 0` | 同期に必要な最小ピア数（プライベートネットは0） |
| `--genesis-state` | 生成したgenesis.sszを指定 |
| `--chain-config-file` | config.yamlを指定 |
| `--chain-id 32382` | Gethと同じchainIdを指定 |
| `--execution-endpoint` | GethのEngine APIエンドポイント |
| `--jwt-secret` | JWT認証ファイル（Gethと同じ） |
| `--contract-deployment-block 0` | Depositコントラクトのデプロイブロック |
| `--p2p-static-id` | P2Pノードの静的ID（再起動時に同じIDを使用） |
| `--bootstrap-node ""` | ブートストラップノードなし |
| `--interop-eth1data-votes` | プライベートネット用のETH1データ投票 |

**起動確認**:
```
time="2025-12-04 07:43:53.35" level=info msg="Starting beacon node" version="Prysm/v7.0.0/..."
time="2025-12-04 07:43:53.37" level=info msg="Initialized head block from DB" slot=0
time="2025-12-04 07:43:53.40" level=info msg="Node started p2p server" multiAddr="/ip4/172.21.220.239/tcp/13000/..."
```

**Beacon Chain API**:
```
http://localhost:3500
```

このAPIを使用してBeacon Chainの状態を確認できます。

## 8. Validatorの起動

### 8.1 Validatorとは

**Validator（バリデータ）**:
- 32 ETHをステーキングしてネットワークに参加
- ブロックを提案・証明する責任
- 正しい動作で報酬を獲得
- 不正行為でペナルティ（スラッシング）

**バリデータの役割**:

1. **ブロック提案**:
   - 順番が来たらブロックを作成
   - トランザクションを含める
   - Beacon Chainに提出

2. **証明（Attestation）**:
   - 各スロットでブロックを検証
   - 正しいブロックに投票
   - Finalityに貢献

### 8.2 InteropモードでのValidator起動

プライベートネットワークでは、**interopモード**を使用します。

```bash
cd ~/eth-private-pos

./dist/validator-v7.0.0-linux-amd64 \
  --datadir consensus/validator-data \
  --accept-terms-of-use \
  --chain-config-file consensus/config.yaml \
  --beacon-rpc-provider localhost:4000 \
  --interop-num-validators 1 \
  --interop-start-index 0
```

**オプションの詳細**:

| オプション | 説明 |
|-----------|------|
| `--datadir` | Validatorのデータディレクトリ |
| `--chain-config-file` | config.yamlを指定 |
| `--beacon-rpc-provider` | Beacon ChainのgRPCエンドポイント |
| `--interop-num-validators 1` | Interopモードで1つのバリデータを使用 |
| `--interop-start-index 0` | バリデータのインデックス（0から開始） |

**Interopモードとは**:

- **Interoperability（相互運用性）テスト**用のモード
- キーストアファイル不要
- `prysmctl testnet generate-genesis --num-validators N`で生成されたキーを自動取得
- プライベートネットワークに最適

**起動確認**:
```
time="2025-12-04 07:47:47.43" level=info msg="Duties schedule" proposerPubkey=0xa99a76ed7796 timeUntilDuty=2m1s
time="2025-12-04 07:47:47.43" level=info msg="Beacon chain started" genesisTime=2025-12-04 07:48:48 +0100 CET
```

**重要なログ**:
- `genesisTime=2025-12-04 07:48:48`: 正しいgenesis time
- `Duties schedule`: バリデータの職務がスケジュールされている

## 9. 動作確認

### 9.1 ブロック生成の確認

#### 9.1.1 Gethのブロック番号確認

```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; data = json.load(sys.stdin); print('Block Number:', int(data['result'], 16))"
```

**出力例**:
```
Block Number: 26
```

#### 9.1.2 Beacon Chainのヘッド確認

```bash
curl -s http://localhost:3500/eth/v1/beacon/headers/head | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); header = data.get('header', {}).get('message', {}); print('Head Slot:', header.get('slot'))"
```

**出力例**:
```
Head Slot: 26
```

#### 9.1.3 Genesis Time確認

```bash
curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); import datetime; print('Genesis Time:', datetime.datetime.fromtimestamp(int(data.get('genesis_time', 0))))"
```

**出力例**:
```
Genesis Time: 2025-12-04 07:48:48
```

### 9.2 動作確認結果

**成功の証拠**:

| 項目 | 値 | 状態 |
|------|---|------|
| Geth Block Number | 26以上 | ✅ 継続的に増加 |
| Beacon Head Slot | 26以上 | ✅ Gethと同期 |
| Genesis Time | 2025-12-04 07:48:48 | ✅ 正しい時刻 |
| ブロック生成間隔 | 12秒 | ✅ 設計通り |

**プロセス状態**:
```bash
ps aux | grep -E "(geth|beacon|validator)"
```

**出力**:
```
158796 geth --datadir execution/data --networkid 32382 ...
158930 ./dist/beacon-chain-v7.0.0-linux-amd64 --datadir consensus/beacon-data ...
159226 ./dist/validator-v7.0.0-linux-amd64 --datadir consensus/validator-data ...
```

3つのプロセスが正常に稼働中！

## 10. 発生した問題と解決方法

### 10.1 問題1: Genesis Timeが2020年になる

#### 10.1.1 問題の症状

```bash
curl -s http://localhost:3500/eth/v1/beacon/genesis
```

**誤った出力**:
```json
{
  "data": {
    "genesis_time": "1606824023",  // 2020-12-01 13:00:23
    "genesis_validators_root": "..."
  }
}
```

**期待される動作**:
- `--genesis-time-delay 120`を指定しているのに、現在時刻から120秒後にならない
- 常に2020年12月1日のmainnet genesis timeになる

#### 10.1.2 根本原因

**原因**: `consensus/config.yaml`の設定ミス

```yaml
CONFIG_NAME: mainnet  # ❌ これが原因
```

**Prysmの動作**:
1. `CONFIG_NAME: mainnet`を検出
2. 内蔵のmainnetプリセットを読み込む
3. mainnetのgenesis time（1606824023）を強制的に適用
4. `--genesis-state`で指定したgenesis.sszを無視
5. `--genesis-time-delay`オプションも無視

**なぜこうなるのか**:

Prysmには以下の内蔵プリセットがあります：
- `mainnet`: Ethereumメインネット
- `goerli`: Goerliテストネット
- `sepolia`: Sepoliaテストネット
- `holesky`: Holeskyテストネット

これらの名前を使用すると、Prysmは内蔵の固定値を使用します。

#### 10.1.3 解決方法

**ステップ1**: `config.yaml`を修正

```yaml
# 変更前
CONFIG_NAME: mainnet

# 変更後
CONFIG_NAME: private-pos
```

**ステップ2**: genesis.sszを再生成

```bash
# 古いgenesis.sszを削除
rm consensus/genesis.ssz

# 新しいgenesis.sszを生成
./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 1 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz
```

**結果**:
```
time="2025-12-04T07:46:48+01:00" level=info msg="Genesis is now 1764830928"
```

正しいgenesis time（2025-12-04 07:48:48）が設定されました！

### 10.2 問題2: GENESIS_FORK_VERSIONの競合

#### 10.2.1 問題の症状

`CONFIG_NAME`を`private-pos`に変更した後、以下のエラーが発生：

```
time="2025-12-04T07:46:37+01:00" level=fatal msg="Could not generate beacon chain genesis state"
error="could not set config params: version 0x00000000 for fork phase0 in config private-pos conflicts with existing config named=mainnet"
```

#### 10.2.2 根本原因

```yaml
CONFIG_NAME: private-pos  # ✅ 変更済み
GENESIS_FORK_VERSION: 0x00000000  # ❌ これがmainnetと同じ
```

**問題**:
- `GENESIS_FORK_VERSION: 0x00000000`はmainnetのデフォルト値
- Prysmは同じfork versionの重複を許可しない
- 「private-posという名前なのに、mainnetのfork versionを使っている」という矛盾

#### 10.2.3 解決方法

**ステップ1**: `config.yaml`のGENESIS_FORK_VERSIONを変更

```yaml
# 変更前
GENESIS_FORK_VERSION: 0x00000000

# 変更後
GENESIS_FORK_VERSION: 0x10000000
```

**ステップ2**: 他のfork versionも一貫性を持たせる

```yaml
ALTAIR_FORK_VERSION: 0x20000000
BELLATRIX_FORK_VERSION: 0x30000000
CAPELLA_FORK_VERSION: 0x40000000
DENEB_FORK_VERSION: 0x50000000
```

**ステップ3**: genesis.sszを再生成

```bash
./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 1 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz
```

**結果**:
```
time="2025-12-04T07:46:48+01:00" level=info msg="Command completed"
```

エラーなく完了！

### 10.3 問題解決のまとめ

**解決した問題**:

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| Genesis Timeが2020年 | `CONFIG_NAME: mainnet` | `CONFIG_NAME: private-pos`に変更 |
| Fork version競合エラー | `GENESIS_FORK_VERSION: 0x00000000` | `GENESIS_FORK_VERSION: 0x10000000`に変更 |
| Validatorがキーを取得できない | deposit_data.jsonとの不一致 | Interopモードを使用 |

**重要な教訓**:

1. **CONFIG_NAMEは必ず固有の名前を使用**
   - `mainnet`, `goerli`, `sepolia`, `holesky`は避ける
   - プライベートネットワーク名を明示的に設定

2. **GENESIS_FORK_VERSIONも固有の値を使用**
   - mainnetの`0x00000000`を避ける
   - ユニークな値（例: `0x10000000`）を設定

3. **deposit_data.jsonは使用しない**
   - プライベートネットワークでは`--num-validators`のみ使用
   - Interopモードでバリデータを起動

4. **データのクリーンアップは完全に**
   - 特に`consensus/beacon-data`は完全削除
   - `rm -rf consensus/beacon-data`を実行

## 11. 正しいセットアップ手順（完全版）

### 11.1 環境準備

```bash
# 作業ディレクトリに移動
cd ~/eth-private-pos

# 既存データをクリーンアップ（再セットアップ時）
rm -rf execution/data/geth consensus/beacon-data consensus/validator-data
```

### 11.2 config.yamlの作成・確認

```bash
# config.yamlを確認
cat consensus/config.yaml

# CONFIG_NAMEとGENESIS_FORK_VERSIONを確認
grep -E "CONFIG_NAME|GENESIS_FORK_VERSION" consensus/config.yaml
```

**期待される出力**:
```
CONFIG_NAME: private-pos
GENESIS_FORK_VERSION: 0x10000000
```

### 11.3 genesis.sszの生成

```bash
./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 1 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz
```

### 11.4 blobScheduleの追加

```bash
python3 << 'PYTHON'
import json

with open('execution/genesis-updated.json', 'r') as f:
    genesis = json.load(f)

if 'blobSchedule' not in genesis.get('config', {}):
    genesis['config']['blobSchedule'] = {
        "cancun": {
            "blobGasTarget": 393216,
            "maxBlobGasPerBlock": 786432
        }
    }

    with open('execution/genesis-updated.json', 'w') as f:
        json.dump(genesis, f, indent='\t')
    print("blobScheduleを追加しました")
else:
    print("blobScheduleは既に存在します")
PYTHON
```

### 11.5 Gethの初期化

```bash
geth init --datadir execution/data execution/genesis-updated.json
```

### 11.6 各コンポーネントの起動（3つのターミナルで実行）

#### ターミナル1: Geth

```bash
cd ~/eth-private-pos

geth --datadir execution/data \
  --networkid 32382 \
  --http \
  --http.api eth,net,web3,engine,admin \
  --http.addr 0.0.0.0 \
  --http.corsdomain "*" \
  --ws \
  --ws.api eth,net,web3,engine,admin \
  --authrpc.addr 0.0.0.0 \
  --authrpc.port 8551 \
  --authrpc.jwtsecret jwt.hex \
  --authrpc.vhosts "*" \
  --nodiscover \
  --syncmode full
```

#### ターミナル2: Beacon Chain

```bash
cd ~/eth-private-pos

./dist/beacon-chain-v7.0.0-linux-amd64 \
  --datadir consensus/beacon-data \
  --min-sync-peers 0 \
  --genesis-state consensus/genesis.ssz \
  --chain-config-file consensus/config.yaml \
  --config-file consensus/config.yaml \
  --chain-id 32382 \
  --execution-endpoint http://localhost:8551 \
  --accept-terms-of-use \
  --jwt-secret jwt.hex \
  --contract-deployment-block 0 \
  --p2p-static-id \
  --bootstrap-node "" \
  --interop-eth1data-votes
```

#### ターミナル3: Validator

```bash
cd ~/eth-private-pos

./dist/validator-v7.0.0-linux-amd64 \
  --datadir consensus/validator-data \
  --accept-terms-of-use \
  --chain-config-file consensus/config.yaml \
  --beacon-rpc-provider localhost:4000 \
  --interop-num-validators 1 \
  --interop-start-index 0
```

### 11.7 動作確認

```bash
# Gethのブロック番号
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; data = json.load(sys.stdin); print('Block Number:', int(data['result'], 16))"

# Beacon Chainのヘッド
curl -s http://localhost:3500/eth/v1/beacon/headers/head | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); header = data.get('header', {}).get('message', {}); print('Head Slot:', header.get('slot'))"

# Genesis Time確認
curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); import datetime; print('Genesis Time:', datetime.datetime.fromtimestamp(int(data.get('genesis_time', 0))))"
```

## 12. ネットワークアーキテクチャの理解

### 12.1 プロセス間通信

```
┌─────────────────────────────────────────────────────┐
│                Ethereum PoS Network                │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌───────────────────────────────────────────┐    │
│  │   Validator (Port: なし)                  │    │
│  │   - ブロック提案・証明                     │    │
│  │   - Interopモード                         │    │
│  └──────────────────┬────────────────────────┘    │
│                     │ gRPC (localhost:4000)       │
│  ┌──────────────────┴────────────────────────┐    │
│  │   Beacon Chain (Port: 4000, 3500)        │    │
│  │   - コンセンサス管理                      │    │
│  │   - バリデータ管理                        │    │
│  │   - HTTP API: localhost:3500              │    │
│  └──────────────────┬────────────────────────┘    │
│                     │ Engine API (JWT認証)        │
│                     │ http://localhost:8551       │
│  ┌──────────────────┴────────────────────────┐    │
│  │   Geth (Port: 8545, 8546, 8551)          │    │
│  │   - 実行レイヤー                          │    │
│  │   - トランザクション処理                   │    │
│  │   - HTTP RPC: localhost:8545              │    │
│  │   - WebSocket: localhost:8546             │    │
│  └───────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 12.2 ポート一覧

| サービス | ポート | プロトコル | 用途 |
|---------|-------|----------|------|
| Geth HTTP RPC | 8545 | HTTP | 外部アプリケーションとの通信 |
| Geth WebSocket | 8546 | WebSocket | リアルタイム通信 |
| Geth Engine API | 8551 | HTTP/WS | Beacon Chainとの通信（JWT認証） |
| Beacon Chain API | 3500 | HTTP | Beacon Chain状態の照会 |
| Beacon Chain gRPC | 4000 | gRPC | Validatorとの通信 |
| Beacon Chain P2P | 13000 | TCP/UDP | 他のBeacon Nodeとの通信 |

### 12.3 データフロー

**ブロック生成の流れ**:

```
1. Validator
   ↓ 「次のスロットでブロックを提案する番です」
2. Beacon Chain
   ↓ Engine API: engine_forkchoiceUpdatedV2
   ↓ 「このスロットでブロックを作成してください」
3. Geth
   ↓ トランザクションプールからトランザクションを選択
   ↓ ブロックを構築
   ↓ Engine API: 完成したブロックを返す
4. Beacon Chain
   ↓ ブロックを検証・署名
   ↓ gRPC: Validatorにブロック情報を送信
5. Validator
   ↓ ブロックに署名
   ↓ ネットワークに提出
6. ブロックがファイナライズ
```

## 13. トラブルシューティング

### 13.1 Beacon Chainが「genesis time 2020年」を表示

**症状**:
```bash
curl -s http://localhost:3500/eth/v1/beacon/genesis
# genesis_time: 1606824023 (2020-12-01)
```

**原因**:
`consensus/config.yaml`の`CONFIG_NAME: mainnet`

**解決**:
```bash
# プロセスを停止
pkill geth
pkill beacon-chain
pkill validator

# config.yamlを修正
sed -i 's/CONFIG_NAME: mainnet/CONFIG_NAME: private-pos/' consensus/config.yaml
sed -i 's/GENESIS_FORK_VERSION: 0x00000000/GENESIS_FORK_VERSION: 0x10000000/' consensus/config.yaml

# データをクリーンアップ
rm -rf consensus/beacon-data execution/data/geth

# genesis.sszを再生成
./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 1 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz

# Gethを再初期化
geth init --datadir execution/data execution/genesis-updated.json

# 全コンポーネントを再起動（セクション11.6参照）
```

### 13.2 Validatorが「No validating keys fetched」

**症状**:
```
time="..." level=warning msg="No validating keys fetched. Waiting for keys..."
```

**原因**:
- Interopモードのパラメータミス
- Beacon Chainが起動していない
- genesis.sszとValidatorのキーが不一致

**解決**:
```bash
# Interopモードで起動していることを確認
./dist/validator-v7.0.0-linux-amd64 \
  --datadir consensus/validator-data \
  --accept-terms-of-use \
  --chain-config-file consensus/config.yaml \
  --beacon-rpc-provider localhost:4000 \
  --interop-num-validators 1 \
  --interop-start-index 0

# Beacon Chainが起動しているか確認
curl http://localhost:3500/eth/v1/node/version

# genesis.sszを--num-validators 1で再生成
```

### 13.3 Gethが「Beacon client online, but no consensus updates」

**症状**:
```
WARN [12-04|07:38:40.879] Beacon client online, but no consensus updates received in a while. Please fix your beacon client to follow the chain!
```

**原因**:
- Beacon ChainがGethに接続していない
- JWT認証エラー
- Genesis timeが未到達

**解決**:
```bash
# JWT秘密鍵が同じか確認
cat jwt.hex

# 両方のプロセスで同じjwt.hexを使用していることを確認
# Geth: --authrpc.jwtsecret jwt.hex
# Beacon: --jwt-secret jwt.hex

# genesis timeを確認
curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); import datetime; print('Genesis Time:', datetime.datetime.fromtimestamp(int(data.get('genesis_time', 0))))"

# 現在時刻がgenesis timeを過ぎているか確認
date
```

### 13.4 ブロックが生成されない

**症状**:
```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545
# 結果: ブロック0のまま
```

**チェックリスト**:

1. **Genesis timeを過ぎているか**:
   ```bash
   curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); import datetime; print('Genesis Time:', datetime.datetime.fromtimestamp(int(data.get('genesis_time', 0))))"
   date
   ```

2. **Validatorが起動しているか**:
   ```bash
   ps aux | grep validator
   ```

3. **Beacon Chainのログにエラーがないか**:
   ```bash
   tail -50 consensus/beacon.log | grep -i error
   ```

4. **Gethのログを確認**:
   ```bash
   tail -50 execution/geth.log | grep -i error
   ```

## 14. 本番環境との違い

### 14.1 プライベートネット vs メインネット

| 項目 | プライベートネット | メインネット |
|------|-----------------|------------|
| chainId | 32382（任意） | 1 |
| バリデータ数 | 1（任意） | 1,000,000以上 |
| ステーキング額 | 不要（Interopモード） | 32 ETH必須 |
| Genesis time | 任意に設定 | 2020-12-01 13:00:23（固定） |
| Finality | すぐに確定 | 2エポック（約13分） |
| ピア接続 | なし（--nodiscover） | 数十〜数百 |
| ETHの価値 | テスト用（価値なし） | 実際の価値あり |
| ブロック生成間隔 | 12秒（設定可能） | 12秒（固定） |

### 14.2 Interopモードの制約

**Interopモードの特徴**:

✅ **メリット**:
- キーストアファイルの管理が不要
- セットアップが簡単
- プライベートネットワークに最適

❌ **デメリット**:
- キーのバックアップが難しい
- 本番環境では使用不可
- セキュリティが低い

**本番環境では**:
```bash
# キーストアファイルをインポート
./dist/validator-v7.0.0-linux-amd64 accounts import \
  --wallet-dir /path/to/wallet \
  --keys-dir /path/to/keystores \
  --wallet-password-file password.txt \
  --account-password-file password.txt

# Validatorを起動
./dist/validator-v7.0.0-linux-amd64 \
  --datadir /path/to/validator-data \
  --wallet-dir /path/to/wallet \
  --wallet-password-file password.txt \
  --beacon-rpc-provider localhost:4000
```

## 15. 学習のまとめ

### 15.1 習得した知識

1. **Ethereum PoSアーキテクチャ**:
   - 実行レイヤー（Geth）とコンセンサスレイヤー（Prysm）の関係
   - Engine APIによる連携
   - JWT認証の仕組み

2. **config.yamlの重要性**:
   - `CONFIG_NAME`は必ず固有の名前を使用
   - `GENESIS_FORK_VERSION`もユニークな値に設定
   - 内蔵プリセットとの競合を避ける

3. **genesis.sszの生成**:
   - `prysmctl testnet generate-genesis`の使用
   - `--num-validators`によるバリデータ生成
   - deposit_data.jsonは使用しない

4. **問題解決能力**:
   - ログの読み方
   - 根本原因の特定方法
   - 段階的なデバッグアプローチ

### 15.2 実践した手順

完全なPoSプライベートネットワークを構築しました：

```bash
# 1. config.yamlの作成（固有の名前・fork versionを使用）
# 2. genesis.sszの生成
# 3. Gethの初期化と起動
# 4. Beacon Chainの起動
# 5. Validatorの起動（Interopモード）
# 6. ブロック生成の確認
```

### 15.3 解決した問題

| 問題 | 解決方法 | 教訓 |
|------|---------|------|
| Genesis Timeが2020年 | `CONFIG_NAME: private-pos`に変更 | 内蔵プリセット名を使用しない |
| Fork version競合 | `GENESIS_FORK_VERSION: 0x10000000`に変更 | mainnetのデフォルト値を避ける |
| Validatorがキーを取得できない | Interopモードを使用 | プライベートネットに適した方法を選択 |

### 15.4 重要なポイント

1. **CONFIG_NAMEは必ず固有の名前**:
   - ✅ `private-pos`, `my-testnet`, `dev-network`
   - ❌ `mainnet`, `goerli`, `sepolia`, `holesky`

2. **GENESIS_FORK_VERSIONも固有の値**:
   - ✅ `0x10000000`, `0xAABBCCDD`
   - ❌ `0x00000000`（mainnetと同じ）

3. **deposit_data.jsonは使用しない**:
   - プライベートネットワークでは`--num-validators`のみ
   - Interopモードで十分

4. **データのクリーンアップは完全に**:
   - `rm -rf consensus/beacon-data`
   - 中途半端なクリーンアップは問題を引き起こす

5. **ログを注意深く読む**:
   - エラーメッセージは問題解決の鍵
   - `grep -i error`で素早くエラーを発見

## 16. 次のステップ

### 16.1 推奨される学習内容

1. **スマートコントラクトのデプロイ**:
   - Remixとの連携
   - トランザクションの送信
   - コントラクトとのやり取り

2. **複数バリデータの運用**:
   - `--num-validators 4`で複数バリデータを生成
   - バリデータの動作を観察
   - ステーキング報酬の分配

3. **アカウント管理**:
   - Gethでアカウント作成
   - genesis.jsonでETHを事前割り当て
   - トランザクションの送信

4. **Web3.jsやEthers.jsとの統合**:
   - JavaScriptからネットワークに接続
   - ブロック情報の取得
   - イベントのリスニング

5. **本番環境への理解**:
   - メインネットとの違い
   - セキュリティベストプラクティス
   - ノード運用の実践

### 16.2 参考リソース

- **Geth公式ドキュメント**: https://geth.ethereum.org/docs/
- **Prysm公式ドキュメント**: https://docs.prylabs.network/
- **Ethereum.org - PoS**: https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/
- **Engine API仕様**: https://github.com/ethereum/execution-apis/tree/main/src/engine
- **Ethereum Beacon APIs**: https://ethereum.github.io/beacon-APIs/

### 16.3 最後に

本学習を通じて、Ethereumの**Proof of Stake**メカニズムを実際に体験し、以下を達成しました：

✅ **完全なPoSプライベートネットワークの構築**
✅ **Geth ↔ Prysm連携の理解**
✅ **継続的なブロック生成の実現**（12秒間隔）
✅ **複雑な問題の根本原因特定と解決**

**The Mergeの重要性**:
2022年9月のThe Merge以降、Ethereumはエネルギー効率的なPoSに移行しました。本学習で構築したネットワークは、まさに本番のEthereumメインネットと同じアーキテクチャを採用しています。

**今後の学習の流れ**:
1. **2025-11-30**: Gethのインストールとプライベートネットワークの基本構築
2. **2025-12-03〜04**: PrysmとGethを連携させたPoSの実装（本学習）
3. **次回**: スマートコントラクトのデプロイとDApp開発

この知識は、DApp開発だけでなく、Ethereumエコシステム全体の理解、さらにはブロックチェーン技術者としてのキャリアに役立ちます。引き続き、実際にスマートコントラクトをデプロイし、Web3アプリケーションを構築してみましょう！

**問題解決の価値**:
本学習で遭遇した「Genesis Time問題」は、単なるバグではなく、Ethereumクライアントの内部動作を深く理解する機会となりました。問題に直面したときこそ、最も多くを学ぶチャンスです。
