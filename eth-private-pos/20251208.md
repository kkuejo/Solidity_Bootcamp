# プライベートPoSネットワークでのJSON-RPC APIの実践

**日付**: 2025年12月8日
**学習内容**: GethとPrysmで構築したプライベートPoSネットワークにおけるJSON-RPC APIとBeacon Chain APIの使用方法、アカウント管理、各種情報の取得方法

## 1. 学習の背景と目的

### 1.1 前回の学習内容

2025年12月3日〜4日の学習では、以下を実施しました：

1. **GethとPrysmを使用したプライベートPoSネットワークの構築**
2. **config.yamlの正しい設定によるGenesis Time問題の解決**
3. **継続的なブロック生成の実現**

これにより、完全に動作するプライベートPoSネットワークが構築できました。

### 1.2 本学習の目的

構築したプライベートPoSネットワークを実際に**操作**し、以下を習得します：

1. **JSON-RPC APIを使用したGethとの対話**
2. **アカウントの作成と管理**
3. **ブロックチェーン情報の取得**
4. **Beacon Chain API（PoS特有）の使用**
5. **バリデータ情報の確認**

### 1.3 Ethereum APIアーキテクチャの理解

**PoSネットワークにおける2つのAPIレイヤー**:

```
┌─────────────────────────────────────────────────────┐
│        Ethereum PoS Network APIs                   │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌───────────────────────────────────────────┐    │
│  │   Beacon Chain API (Prysm)               │    │
│  │   http://localhost:3500                   │    │
│  │   --------------------------------         │    │
│  │   - バリデータ情報                        │    │
│  │   - スロット/エポック情報                  │    │
│  │   - 同期状態                             │    │
│  │   - コンセンサスレイヤーの状態             │    │
│  └───────────────────────────────────────────┘    │
│                                                     │
│  ┌───────────────────────────────────────────┐    │
│  │   JSON-RPC API (Geth)                    │    │
│  │   http://localhost:8545                   │    │
│  │   IPC: execution/data/geth.ipc            │    │
│  │   --------------------------------         │    │
│  │   - アカウント管理                        │    │
│  │   - トランザクション送信                   │    │
│  │   - ブロック情報                          │    │
│  │   - 残高確認                             │    │
│  │   - スマートコントラクト実行               │    │
│  └───────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**各APIの役割**:

| API | エンドポイント | 用途 |
|-----|-------------|------|
| **JSON-RPC API** | http://localhost:8545<br>execution/data/geth.ipc | Ethereum本来の機能（トランザクション、スマートコントラクト等） |
| **Beacon Chain API** | http://localhost:3500 | PoS特有の機能（バリデータ、スロット、証明等） |

## 2. JSON-RPC APIの基本

### 2.1 JSON-RPCとは

**JSON-RPC**（JSON Remote Procedure Call）:
- HTTPやWebSocketを使用してリモートのメソッドを呼び出すプロトコル
- JSON形式でリクエスト・レスポンスを交換
- Ethereumノードとの通信標準

**基本的なリクエスト形式**:

```json
{
  "jsonrpc": "2.0",
  "method": "メソッド名",
  "params": [パラメータ],
  "id": 1
}
```

**レスポンス形式**:

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": "結果"
}
```

### 2.2 接続方法

Gethには3つの接続方法があります：

#### 2.2.1 HTTP接続

```bash
# curlを使用した直接アクセス
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545
```

**メリット**:
- ✅ シンプルで理解しやすい
- ✅ ファイアウォール越しにアクセス可能
- ✅ 任意のプログラミング言語から利用可能

**デメリット**:
- ❌ リアルタイム通知（サブスクリプション）が使えない

#### 2.2.2 WebSocket接続

```bash
# wscat（WebSocketクライアント）を使用
wscat -c ws://localhost:8546
```

**メリット**:
- ✅ リアルタイム通知（新しいブロック、イベント等）が受信可能
- ✅ 双方向通信

**デメリット**:
- ❌ HTTP接続より複雑

#### 2.2.3 IPC接続（Unix Domain Socket）

```bash
# geth attachコマンドを使用
geth attach execution/data/geth.ipc

# または
geth attach ipc:execution/data/geth.ipc
```

**メリット**:
- ✅ 最も高速（ローカルソケット通信）
- ✅ セキュア（ローカルファイルシステム経由）
- ✅ 対話型コンソールが使える

**デメリット**:
- ❌ 同じマシン内でのみ使用可能

### 2.3 接続可能なAPIモジュール

Geth起動時に`--http.api`オプションで指定：

```bash
--http.api eth,net,web3,engine,admin
```

| モジュール | 説明 | 主な用途 |
|----------|------|---------|
| `eth` | Ethereum関連 | ブロック情報、トランザクション、残高確認 |
| `net` | ネットワーク関連 | ピア情報、ネットワークID |
| `web3` | Web3関連 | クライアントバージョン、SHA3ハッシュ |
| `engine` | Engine API | Beacon ChainとGethの通信（通常は内部使用） |
| `admin` | 管理機能 | ピア管理、ノード情報 |
| `personal` | アカウント管理 | アカウント作成、ロック解除（非推奨） |
| `txpool` | トランザクションプール | 保留中のトランザクション確認 |
| `debug` | デバッグ機能 | トレース、スタックトレース |

**セキュリティ上の注意**:
- `personal`, `admin`, `debug`は本番環境では公開しない
- HTTPで公開する場合は必ず`--http.corsdomain`や`--http.vhosts`で制限する

## 3. アカウント管理

### 3.1 アカウントの作成

#### 3.1.1 コマンドラインでの作成（推奨）

```bash
# パスワードファイルを作成
echo 'password123' > /tmp/account_password.txt

# アカウントを作成
geth account new --datadir execution/data --password /tmp/account_password.txt
```

**出力例**:
```
Your new key was generated

Public address of the key:   0x8B9A659aF5964720820C9A2398100677AE0AC9b0
Path of the secret key file: execution/data/keystore/UTC--2025-12-08T22-47-40.515600541Z--8b9a659af5964720820c9a2398100677ae0ac9b0

- You can share your public address with anyone. Others need it to interact with you.
- You must NEVER share the secret key with anyone! The key controls access to your funds!
- You must BACKUP your key file! Without the key, it's impossible to access account funds!
- You must REMEMBER your password! Without the password, it's impossible to decrypt the key!
```

**重要な要素**:

| 項目 | 説明 | 扱い |
|------|------|------|
| **Public Address** | 0x8B9A65... | 公開OK（他者がETHを送信する際に使用） |
| **Secret Key File** | execution/data/keystore/UTC--... | **絶対に秘密！バックアップ必須** |
| **Password** | password123 | **絶対に秘密！忘れたら復元不可** |

#### 3.1.2 アカウントリストの確認

```bash
# JSON-RPC経由で確認
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_accounts","params":[],"id":1}' \
  http://localhost:8545
```

**出力例**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": [
    "0x8b9a659af5964720820c9a2398100677ae0ac9b0",
    "0x937a430ef97920ea2fefa5bc71c11db6c6cae540"
  ]
}
```

#### 3.1.3 keystoreファイルの構造

作成されたアカウントは**keystore**ディレクトリに保存されます：

```bash
ls -l execution/data/keystore/
```

**出力例**:
```
-rw------- 1 user user 491 Dec  8 23:47 UTC--2025-12-08T22-47-40.515600541Z--8b9a659af5964720820c9a2398100677ae0ac9b0
```

**keystoreファイルの中身**（JSON形式）:

```json
{
  "address": "8b9a659af5964720820c9a2398100677ae0ac9b0",
  "crypto": {
    "cipher": "aes-128-ctr",
    "ciphertext": "...",
    "cipherparams": { "iv": "..." },
    "kdf": "scrypt",
    "kdfparams": { ... },
    "mac": "..."
  },
  "id": "...",
  "version": 3
}
```

**セキュリティ機構**:
- 秘密鍵はパスワードで**暗号化**されて保存
- `scrypt`という強力なキー導出関数を使用
- パスワードなしでは秘密鍵を復号できない

### 3.2 personal APIの非推奨化

以前は`personal.newAccount()`や`personal.unlockAccount()`が使用されていましたが、現在は**非推奨**です。

**理由**:
1. セキュリティリスク（HTTPで平文パスワードを送信）
2. アカウント管理は外部ツール（Clef、MetaMask等）に移行

**代替方法**:
- **Clef**: Geth公式のアカウント管理・署名ツール
- **MetaMask**: ブラウザ拡張機能
- **Hardhat/Foundry**: 開発環境での自動管理

## 4. JSON-RPC操作の実践

### 4.1 ブロック番号の取得

```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545
```

**レスポンス**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": "0x2d"  // 16進数（0x2d = 45）
}
```

**10進数に変換**:
```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; data = json.load(sys.stdin); print('Block Number:', int(data['result'], 16))"
```

**出力**:
```
Block Number: 45
```

### 4.2 残高の確認

```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{
    "jsonrpc":"2.0",
    "method":"eth_getBalance",
    "params":["0x8b9a659af5964720820c9a2398100677ae0ac9b0", "latest"],
    "id":1
  }' \
  http://localhost:8545
```

**パラメータ**:
1. アドレス: `0x8b9a659af5964720820c9a2398100677ae0ac9b0`
2. ブロック: `latest`（最新）、`earliest`（最古）、または16進数のブロック番号

**レスポンス**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": "0x0"  // 0 Wei（残高なし）
}
```

**Wei単位について**:

Ethereumでは以下の単位が使用されます：

| 単位 | Wei換算 | 説明 |
|------|---------|------|
| Wei | 1 | 最小単位 |
| Kwei (babbage) | 10³ | 1,000 Wei |
| Mwei (lovelace) | 10⁶ | 1,000,000 Wei |
| Gwei (shannon) | 10⁹ | 1,000,000,000 Wei（ガス価格でよく使用） |
| Szabo | 10¹² | 1,000,000,000,000 Wei |
| Finney | 10¹⁵ | 1,000,000,000,000,000 Wei |
| **Ether** | 10¹⁸ | 1,000,000,000,000,000,000 Wei |

**例**: 1 ETH = 1,000,000,000,000,000,000 Wei

### 4.3 ブロック情報の取得

```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{
    "jsonrpc":"2.0",
    "method":"eth_getBlockByNumber",
    "params":["latest", false],
    "id":1
  }' \
  http://localhost:8545 | python3 -c "import sys, json; print(json.dumps(json.load(sys.stdin), indent=2))"
```

**パラメータ**:
1. ブロック番号: `latest`, `earliest`, `pending`, または16進数
2. トランザクション詳細: `true`（全詳細）、`false`（ハッシュのみ）

**レスポンス例**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "number": "0x2d",
    "hash": "0xd0753eb99a65fc4692794d873e775fa730e5f0b56a775413b4ed9b4b4db58461",
    "parentHash": "0x...",
    "timestamp": "0x67562f88",
    "difficulty": "0x0",
    "gasLimit": "0x8000000",
    "gasUsed": "0x0",
    "miner": "0x0000000000000000000000000000000000000000",
    "transactions": []
  }
}
```

**重要なフィールド**:

| フィールド | 説明 |
|----------|------|
| `number` | ブロック番号 |
| `hash` | ブロックハッシュ（ブロックの一意識別子） |
| `parentHash` | 親ブロックのハッシュ（チェーン構造） |
| `timestamp` | ブロック生成時刻（Unix時間） |
| `gasLimit` | ブロックのガス上限 |
| `gasUsed` | 実際に使用されたガス |
| `miner` | ブロック提案者（PoSでは0x0...0） |
| `transactions` | トランザクションリスト |

### 4.4 同期状態の確認

```bash
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}' \
  http://localhost:8545
```

**完全同期している場合**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": false
}
```

**同期中の場合**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "startingBlock": "0x0",
    "currentBlock": "0x64",
    "highestBlock": "0x12c"
  }
}
```

### 4.5 ネットワーク情報の取得

```bash
# ネットワークID
curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"net_version","params":[],"id":1}' \
  http://localhost:8545
```

**レスポンス**:
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": "32382"  // 私たちのプライベートネットワークのID
}
```

**主要なネットワークID**:

| ネットワーク | ID |
|------------|-----|
| Ethereum Mainnet | 1 |
| Goerli Testnet | 5 |
| Sepolia Testnet | 11155111 |
| **私たちのプライベートネット** | **32382** |

## 5. Beacon Chain API（PoS特有）

PoSネットワークでは、Gethの**JSON-RPC API**に加えて、Prysmの**Beacon Chain API**も使用できます。

### 5.1 Beacon Chain APIとは

**Beacon Chain API**:
- Ethereumの公式REST API仕様に準拠
- コンセンサスレイヤー（PoS）の情報を取得
- HTTPのGETリクエストで簡単にアクセス可能

**エンドポイント**: `http://localhost:3500`

**APIドキュメント**: https://ethereum.github.io/beacon-APIs/

### 5.2 同期状態の確認

```bash
curl -s http://localhost:3500/eth/v1/node/syncing | python3 -c "import sys, json; print(json.dumps(json.load(sys.stdin), indent=2))"
```

**レスポンス**:
```json
{
  "data": {
    "head_slot": "47",
    "sync_distance": "0",
    "is_syncing": false,
    "is_optimistic": false,
    "el_offline": false
  }
}
```

**フィールドの説明**:

| フィールド | 説明 |
|----------|------|
| `head_slot` | 現在のヘッドスロット番号 |
| `sync_distance` | 同期が必要な残りスロット数 |
| `is_syncing` | 同期中かどうか（false = 完全同期） |
| `is_optimistic` | オプティミスティック同期中かどうか |
| `el_offline` | 実行レイヤー（Geth）がオフラインかどうか |

### 5.3 バリデータ情報の取得

```bash
curl -s http://localhost:3500/eth/v1/beacon/states/head/validators | python3 -c "import sys, json; data = json.load(sys.stdin); print('Total Validators:', len(data.get('data', [])))"
```

**出力**:
```
Total Validators: 1
```

**詳細情報を確認**:
```bash
curl -s http://localhost:3500/eth/v1/beacon/states/head/validators | python3 -c "import sys, json; print(json.dumps(json.load(sys.stdin)['data'][0], indent=2))"
```

**レスポンス**:
```json
{
  "index": "0",
  "balance": "32001957509",
  "status": "active_ongoing",
  "validator": {
    "pubkey": "0xa99a76ed7796f7be22d5b7e85deeb7c5677e88e511e0b337618f8c4eb61349b4bf2d153f649f7b53359fe8b94a38e44c",
    "withdrawal_credentials": "0x00fad2a6bfb0e7f1f0f45460944fbd8dfa7f37da06a4d13b3983cc90bb46963b",
    "effective_balance": "32000000000",
    "slashed": false,
    "activation_eligibility_epoch": "0",
    "activation_epoch": "0",
    "exit_epoch": "18446744073709551615",
    "withdrawable_epoch": "18446744073709551615"
  }
}
```

**バリデータのステータス**:

| ステータス | 説明 |
|----------|------|
| `pending_initialized` | デポジット受領済み、アクティベーション待ち |
| `pending_queued` | アクティベーション待機列 |
| `active_ongoing` | **アクティブ（現在証明中）** |
| `active_exiting` | 退出プロセス中 |
| `active_slashed` | スラッシュされた（不正行為） |
| `exited_unslashed` | 正常に退出 |
| `exited_slashed` | スラッシュ後退出 |
| `withdrawal_possible` | 引き出し可能 |
| `withdrawal_done` | 引き出し完了 |

**バリデータの残高**:
- `balance`: 32001957509 Gwei = 32.001957509 ETH
- `effective_balance`: 32000000000 Gwei = 32 ETH（報酬計算用）

報酬が少しずつ増加していることがわかります！

### 5.4 チェーンヘッド情報の取得

```bash
curl -s http://localhost:3500/eth/v1/beacon/headers/head | python3 -c "import sys, json; data = json.load(sys.stdin); header = data.get('data', {}).get('header', {}).get('message', {}); print('Slot:', header.get('slot')); print('Proposer Index:', header.get('proposer_index')); print('Parent Root:', header.get('parent_root')); print('State Root:', header.get('state_root'))"
```

**出力**:
```
Slot: 48
Proposer Index: 0
Parent Root: 0xd0753eb99a65fc4692794d873e775fa730e5f0b56a775413b4ed9b4b4db58461
State Root: 0x410be17c268f06e3d5a025b1ebb58bcf66e5897c63f9d264c53eb1aa68d50d11
```

**フィールドの説明**:

| フィールド | 説明 |
|----------|------|
| `slot` | 現在のスロット番号（12秒ごとに+1） |
| `proposer_index` | ブロック提案者のバリデータインデックス |
| `parent_root` | 親ブロックのルートハッシュ |
| `state_root` | Beacon Chainの状態ルートハッシュ |

### 5.5 Genesis情報の確認

```bash
curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "import sys, json; data = json.load(sys.stdin).get('data', {}); import datetime; print('Genesis Time:', datetime.datetime.fromtimestamp(int(data.get('genesis_time', 0)))); print('Genesis Validators Root:', data.get('genesis_validators_root'))"
```

**出力**:
```
Genesis Time: 2025-12-08 23:39:15
Genesis Validators Root: 0x2981d7b74aef065bf8a3c448b51251552570aac44015cf00e0077dd30df530b7
```

## 6. 実践例：ブロックチェーン情報の総合確認

### 6.1 一括情報取得スクリプト

以下のスクリプトで、ネットワークの状態を一目で確認できます：

```bash
#!/bin/bash

echo "========================================="
echo "  Ethereum Private PoS Network Status  "
echo "========================================="
echo ""

# Geth情報
echo "【Execution Layer (Geth)】"
BLOCK_NUM=$(curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; data = json.load(sys.stdin); print(int(data['result'], 16))")
echo "  Block Number: $BLOCK_NUM"

NETWORK_ID=$(curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"net_version","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; print(json.load(sys.stdin)['result'])")
echo "  Network ID: $NETWORK_ID"

ACCOUNTS=$(curl -s -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_accounts","params":[],"id":1}' \
  http://localhost:8545 | python3 -c "import sys, json; print(len(json.load(sys.stdin)['result']))")
echo "  Accounts: $ACCOUNTS"

echo ""

# Beacon Chain情報
echo "【Consensus Layer (Beacon Chain)】"
curl -s http://localhost:3500/eth/v1/beacon/headers/head | python3 -c "
import sys, json
data = json.load(sys.stdin)
header = data.get('data', {}).get('header', {}).get('message', {})
print(f\"  Current Slot: {header.get('slot')}\")
print(f\"  Proposer Index: {header.get('proposer_index')}\")
"

VALIDATORS=$(curl -s http://localhost:3500/eth/v1/beacon/states/head/validators | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('data', [])))")
echo "  Active Validators: $VALIDATORS"

curl -s http://localhost:3500/eth/v1/beacon/genesis | python3 -c "
import sys, json, datetime
data = json.load(sys.stdin).get('data', {})
genesis_time = int(data.get('genesis_time', 0))
print(f\"  Genesis Time: {datetime.datetime.fromtimestamp(genesis_time)}\")
"

echo ""
echo "========================================="
```

**実行結果例**:
```
=========================================
  Ethereum Private PoS Network Status
=========================================

【Execution Layer (Geth)】
  Block Number: 48
  Network ID: 32382
  Accounts: 2

【Consensus Layer (Beacon Chain)】
  Current Slot: 48
  Proposer Index: 0
  Active Validators: 1
  Genesis Time: 2025-12-08 23:39:15

=========================================
```

### 6.2 ブロック生成の観察

以下のスクリプトで、リアルタイムにブロック生成を観察できます：

```bash
#!/bin/bash

echo "Watching block production (Ctrl+C to stop)..."
echo ""

while true; do
  GETH_BLOCK=$(curl -s -X POST -H "Content-Type: application/json" \
    --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
    http://localhost:8545 | python3 -c "import sys, json; data = json.load(sys.stdin); print(int(data['result'], 16))")

  BEACON_SLOT=$(curl -s http://localhost:3500/eth/v1/beacon/headers/head | python3 -c "import sys, json; data = json.load(sys.stdin); header = data.get('data', {}).get('header', {}).get('message', {}); print(header.get('slot'))")

  TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

  echo "[$TIMESTAMP] Geth Block: $GETH_BLOCK | Beacon Slot: $BEACON_SLOT"

  sleep 12
done
```

**出力例**:
```
Watching block production (Ctrl+C to stop)...

[2025-12-08 23:48:00] Geth Block: 48 | Beacon Slot: 48
[2025-12-08 23:48:12] Geth Block: 49 | Beacon Slot: 49
[2025-12-08 23:48:24] Geth Block: 50 | Beacon Slot: 50
[2025-12-08 23:48:36] Geth Block: 51 | Beacon Slot: 51
```

12秒ごとに新しいブロックが生成されていることが確認できます！

## 7. web3.jsでの接続（参考）

実際のDApp開発では、**web3.js**や**ethers.js**といったライブラリを使用します。

### 7.1 web3.jsのインストール

```bash
npm install web3
```

### 7.2 基本的な接続例

```javascript
const Web3 = require('web3');

// Geth（Execution Layer）に接続
const web3 = new Web3('http://localhost:8545');

async function main() {
  // ネットワークIDを取得
  const networkId = await web3.eth.net.getId();
  console.log('Network ID:', networkId);

  // 最新ブロック番号を取得
  const blockNumber = await web3.eth.getBlockNumber();
  console.log('Block Number:', blockNumber);

  // アカウントリストを取得
  const accounts = await web3.eth.getAccounts();
  console.log('Accounts:', accounts);

  // 残高を取得（Wei単位）
  if (accounts.length > 0) {
    const balance = await web3.eth.getBalance(accounts[0]);
    console.log('Balance (Wei):', balance);

    // ETH単位に変換
    const balanceEth = web3.utils.fromWei(balance, 'ether');
    console.log('Balance (ETH):', balanceEth);
  }
}

main().catch(console.error);
```

**出力例**:
```
Network ID: 32382
Block Number: 52
Accounts: [
  '0x8b9a659af5964720820c9a2398100677ae0ac9b0',
  '0x937a430ef97920ea2fefa5bc71c11db6c6cae540'
]
Balance (Wei): 0
Balance (ETH): 0
```

### 7.3 ethers.jsの例

```javascript
const { ethers } = require('ethers');

// プロバイダーを作成
const provider = new ethers.JsonRpcProvider('http://localhost:8545');

async function main() {
  // ネットワーク情報を取得
  const network = await provider.getNetwork();
  console.log('Chain ID:', network.chainId);

  // ブロック番号を取得
  const blockNumber = await provider.getBlockNumber();
  console.log('Block Number:', blockNumber);

  // ブロック情報を取得
  const block = await provider.getBlock(blockNumber);
  console.log('Latest Block:', {
    number: block.number,
    hash: block.hash,
    timestamp: new Date(block.timestamp * 1000),
    gasUsed: block.gasUsed.toString()
  });
}

main().catch(console.error);
```

## 8. よくある操作とトラブルシューティング

### 8.1 personalモジュールが使えない

**症状**:
```
{"jsonrpc":"2.0","id":1,"error":{"code":-32601,"message":"the method personal_newAccount does not exist/is not available"}}
```

**原因**:
- `personal` APIモジュールが有効になっていない
- 最近のGethでは`personal` APIは非推奨

**解決方法**:

1. **コマンドラインでアカウント作成**（推奨）:
   ```bash
   geth account new --datadir execution/data --password /tmp/password.txt
   ```

2. **Geth起動時にpersonalモジュールを有効化**（非推奨）:
   ```bash
   --http.api eth,net,web3,engine,admin,personal
   ```

### 8.2 IPCソケットが見つからない

**症状**:
```
Fatal: Unable to attach to remote geth: dial unix execution/data/geth.ipc: connect: no such file or directory
```

**原因**:
- Gethが起動していない
- IPCが無効化されている
- パスが間違っている

**解決方法**:

1. **Gethが起動しているか確認**:
   ```bash
   ps aux | grep geth
   ```

2. **IPCソケットの存在を確認**:
   ```bash
   ls -l execution/data/geth.ipc
   ```

3. **正しいパスを指定**:
   ```bash
   geth attach execution/data/geth.ipc
   ```

### 8.3 CORS エラー（ブラウザから接続する場合）

**症状**:
```
Access to fetch at 'http://localhost:8545' from origin 'http://localhost:3000' has been blocked by CORS policy
```

**原因**:
- Gethが異なるオリジンからのリクエストを拒否

**解決方法**:

Geth起動時に`--http.corsdomain`を指定：

```bash
--http.corsdomain "http://localhost:3000"

# または全て許可（開発環境のみ）
--http.corsdomain "*"
```

## 9. セキュリティベストプラクティス

### 9.1 本番環境での注意事項

| 項目 | プライベートネット | 本番環境 |
|------|-----------------|---------|
| `--http.addr` | 0.0.0.0（全て許可） | 127.0.0.1（ローカルのみ） |
| `--http.corsdomain` | "*"（全て許可） | 特定のドメインのみ |
| `--http.api` | eth,net,web3,engine,admin | eth,net,web3のみ |
| `personal` API | 使用可（テスト用） | **絶対に使用しない** |
| パスワード | 簡易的（password123） | 強固な複雑パスワード |
| keystoreバックアップ | ローカルのみ | **複数の安全な場所** |

### 9.2 keystoreの保護

**やるべきこと**:
- ✅ keystoreファイルを定期的にバックアップ
- ✅ バックアップは暗号化して保存
- ✅ パスワードは別の場所に保管
- ✅ ハードウェアウォレット（Ledger等）の使用を検討

**やってはいけないこと**:
- ❌ keystoreファイルをGitHubにコミット
- ❌ パスワードを平文で保存
- ❌ 秘密鍵を他人と共有
- ❌ HTTPSなしでpersonal APIを公開

## 10. 学習のまとめ

### 10.1 習得した知識

1. **JSON-RPC APIの基本**:
   - リクエスト・レスポンス形式の理解
   - HTTP、WebSocket、IPC接続の違い
   - 主要なAPIモジュール（eth, net, web3等）

2. **アカウント管理**:
   - コマンドラインでのアカウント作成
   - keystoreファイルの仕組み
   - セキュリティベストプラクティス

3. **基本的なJSON-RPC操作**:
   - ブロック番号の取得（`eth_blockNumber`）
   - 残高確認（`eth_getBalance`）
   - ブロック情報の取得（`eth_getBlockByNumber`）
   - アカウントリスト（`eth_accounts`）
   - ネットワーク情報（`net_version`）

4. **Beacon Chain API（PoS特有）**:
   - 同期状態の確認
   - バリデータ情報の取得
   - スロット/エポック情報
   - Genesis情報の確認

5. **実践的なスクリプト作成**:
   - ネットワーク状態の総合確認スクリプト
   - ブロック生成の監視スクリプト

### 10.2 実践した操作

| 操作 | 使用したAPI | 成功 |
|------|-----------|------|
| HTTP接続の確認 | `eth_blockNumber` | ✅ |
| アカウント作成 | `geth account new` | ✅ |
| アカウントリスト取得 | `eth_accounts` | ✅ |
| 残高確認 | `eth_getBalance` | ✅ |
| ブロック情報取得 | `eth_getBlockByNumber` | ✅ |
| ネットワーク情報 | `net_version` | ✅ |
| Beacon Chain同期状態 | `/eth/v1/node/syncing` | ✅ |
| バリデータ情報 | `/eth/v1/beacon/states/head/validators` | ✅ |
| チェーンヘッド | `/eth/v1/beacon/headers/head` | ✅ |
| Genesis情報 | `/eth/v1/beacon/genesis` | ✅ |

### 10.3 APIアーキテクチャの理解

```
┌─────────────────────────────────────────────────────┐
│      Ethereum PoS Network - 2層構造のAPI           │
├─────────────────────────────────────────────────────┤
│                                                     │
│  【Consensus Layer API】                           │
│  ┌───────────────────────────────────────────┐    │
│  │ Beacon Chain API (Prysm)                 │    │
│  │ http://localhost:3500                     │    │
│  │ --------------------------------          │    │
│  │ ✓ バリデータ情報                         │    │
│  │ ✓ スロット/エポック                      │    │
│  │ ✓ 証明（attestation）                    │    │
│  │ ✓ 同期状態                              │    │
│  └───────────────────────────────────────────┘    │
│             ↕ Engine API (JWT認証)                │
│  【Execution Layer API】                           │
│  ┌───────────────────────────────────────────┐    │
│  │ JSON-RPC API (Geth)                      │    │
│  │ http://localhost:8545                     │    │
│  │ IPC: execution/data/geth.ipc              │    │
│  │ --------------------------------          │    │
│  │ ✓ アカウント管理                         │    │
│  │ ✓ トランザクション                       │    │
│  │ ✓ スマートコントラクト                    │    │
│  │ ✓ ブロック情報                           │    │
│  └───────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 10.4 重要なポイント

1. **2つのAPIレイヤー**:
   - **JSON-RPC API（Geth）**: 従来のEthereum機能
   - **Beacon Chain API（Prysm）**: PoS特有の機能

2. **接続方法の選択**:
   - **HTTP**: シンプル、汎用的
   - **WebSocket**: リアルタイム通知が必要な場合
   - **IPC**: ローカルで最速・最もセキュア

3. **personalモジュールは非推奨**:
   - アカウント作成は`geth account new`を使用
   - Clefやハードウェアウォレットの活用

4. **単位の理解**:
   - 1 ETH = 10¹⁸ Wei
   - ガス価格はGwei（10⁹ Wei）で表示されることが多い

5. **バリデータの報酬**:
   - 正しくブロックを提案・証明することで報酬を獲得
   - 残高が少しずつ増加（32.001957509 ETH）

## 11. 次のステップ

### 11.1 推奨される学習内容

1. **トランザクションの送信**:
   - genesis.jsonでアカウントにETHを事前割り当て
   - `eth_sendTransaction`でトランザクション送信
   - ガス代の理解

2. **スマートコントラクトのデプロイ**:
   - Solidityでコントラクト作成
   - Remixやハードハットでコンパイル
   - `eth_sendTransaction`でデプロイ

3. **イベントのリスニング**:
   - WebSocketでリアルタイム通知
   - `eth_subscribe`で新しいブロックを監視
   - ログのフィルタリング

4. **web3.js/ethers.jsの本格活用**:
   - DAppのフロントエンド開発
   - MetaMaskとの連携
   - コントラクトとのやり取り

5. **Beacon Chain APIの深掘り**:
   - 証明（attestation）の監視
   - スラッシング条件の理解
   - 報酬とペナルティの計算

### 11.2 参考リソース

- **Geth JSON-RPC API**: https://geth.ethereum.org/docs/interacting-with-geth/rpc
- **Ethereum Beacon APIs**: https://ethereum.github.io/beacon-APIs/
- **web3.js ドキュメント**: https://web3js.readthedocs.io/
- **ethers.js ドキュメント**: https://docs.ethers.org/
- **Ethereum.org - JSON-RPC**: https://ethereum.org/en/developers/docs/apis/json-rpc/

### 11.3 最後に

本学習を通じて、以下を達成しました：

✅ **JSON-RPC APIの基本的な使い方を習得**
✅ **アカウントの作成と管理方法を理解**
✅ **ブロックチェーン情報の取得方法を実践**
✅ **Beacon Chain API（PoS特有）の使用方法を学習**
✅ **実用的なスクリプトの作成**

**PoS vs PoWの違い**:
- PoW（Proof of Work）では、マイナー情報のみ
- **PoS（Proof of Stake）では、バリデータ情報、証明、スロット/エポック等の追加情報**

本学習で構築したプライベートPoSネットワークは、まさに**本番のEthereum Mainnetと同じアーキテクチャ**です。

**学習の流れ**:
1. **2025-12-03〜04**: PoSネットワークの構築（Geth + Prysm）
2. **2025-12-08**: JSON-RPC APIとBeacon Chain APIの実践（本学習）
3. **次回**: トランザクション送信とスマートコントラクトデプロイ

この知識は、DApp開発、ブロックチェーンエンジニアリング、そしてWeb3エコシステム全体の理解に直結します。実際にAPIを叩いて、ブロックチェーンと対話する体験は、書籍やチュートリアルだけでは得られない貴重な学びです。

引き続き、トランザクションの送信やスマートコントラクトのデプロイに挑戦し、実践的なDApp開発へと進んでいきましょう！
