# プライベートPoSネットワークでのバリデータ動作確認と報酬検証

**日付**: 2025年12月9日
**学習内容**: GethとPrysmで構築したプライベートPoSネットワークにおける4バリデータでのブロック生成、attestation送信、および報酬の確認

## 1. 学習の背景と目的

### 1.1 前回までの学習内容

- **2025年12月3日〜4日**: GethとPrysmを使用したプライベートPoSネットワークの構築
- **2025年12月8日**: JSON-RPC APIとBeacon Chain APIの実践

これにより、完全に動作するプライベートPoSネットワークと、その操作方法を習得しました。

### 1.2 本学習の目的

構築したプライベートPoSネットワークで、実際に**PoS（Proof of Stake）の動作**を確認します：

1. **バリデータが正常に動作しているか確認**
2. **ブロック生成とattestationの確認**
3. **報酬の発生を確認**
4. **PoSの仕組みを実際に体験する**

### 1.3 なぜ4バリデータが必要か

**単一バリデータの問題点**:
- ファイナライゼーション（確定）が困難
- attestation（証明）の送信が制限される
- ブロック生成が不安定

**4バリデータの利点**:
- ✅ 安定したブロック生成
- ✅ ファイナライゼーションの実現
- ✅ attestationとblockの両方が正常に送信される
- ✅ 本番環境に近い動作

**簡単に言うと**:
- **単一バリデータ** = 「一人で銀行を運営」→ 無理がある
- **4バリデータ** = 「4人で協力して銀行を運営」→ 安定的に運営できる

## 2. 4バリデータでのセットアップ手順

### 2.1 全プロセスの停止

既存のプロセスを全て停止します：

```bash
killall -9 geth beacon-chain-v7.0.0-linux-amd64 validator-v7.0.0-linux-amd64
sleep 2
ps aux | grep -E "(geth|beacon|validator)" | grep -v grep
```

**確認**: 何も表示されなければ、全プロセスが停止しています。

### 2.2 データディレクトリのクリーンアップ

古いデータを完全に削除します：

```bash
rm -rf consensus/beacon-data consensus/validator-data execution/data/geth consensus/genesis.ssz execution/genesis-updated.json
echo "Data cleaned successfully"
```

**重要**: config.yamlとjwt.hexは削除**しません**。

### 2.3 4バリデータでgenesis.sszを生成

```bash
./prysmctl testnet generate-genesis \
  --fork deneb \
  --num-validators 4 \
  --genesis-time-delay 120 \
  --chain-config-file consensus/config.yaml \
  --geth-genesis-json-in execution/genesis.json \
  --geth-genesis-json-out execution/genesis-updated.json \
  --output-ssz consensus/genesis.ssz
```

**出力例**:
```
time="2025-12-09T23:05:47+01:00" level=info msg="Genesis is now 1765318067"
time="2025-12-09T23:05:47+01:00" level=info msg="Done writing genesis state to consensus/genesis.ssz"
```

**重要なポイント**:
- **--num-validators 4**: 4つのバリデータを生成
- Genesis Time: 1765318067（2025-12-09 23:07:47）
- 現在時刻から120秒後に設定

### 2.4 Gethを初期化

```bash
geth init --datadir execution/data execution/genesis-updated.json
```

**出力例**:
```
INFO [12-09|23:05:55.944] Successfully wrote genesis state database=chaindata hash=d29b34..72500b
```

### 2.5 全プロセスを起動

#### ステップ1: Gethを起動

```bash
geth --datadir execution/data \
  --networkid 32382 \
  --http \
  --http.api eth,net,web3,engine,admin \
  --http.addr 0.0.0.0 \
  --http.corsdomain "*" \
  --ws \
  --ws.api eth,net,web3,engine,admin \
  --authrpc.addr 0.0.0.0 \
  --authrpc.port 8551 \
  --authrpc.jwtsecret jwt.hex \
  --authrpc.vhosts "*" \
  --nodiscover \
  --syncmode full > geth.log 2>&1 &
```

#### ステップ2: Beacon Chainを起動

```bash
./dist/beacon-chain-v7.0.0-linux-amd64 \
  --datadir consensus/beacon-data \
  --min-sync-peers 0 \
  --genesis-state consensus/genesis.ssz \
  --chain-config-file consensus/config.yaml \
  --config-file consensus/config.yaml \
  --chain-